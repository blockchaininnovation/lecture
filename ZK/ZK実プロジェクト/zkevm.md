<center>
  **ZkEvm: スマートコントラクトにロールアップを**
</center>

ZKEVMは、Ethereumでサポートされているようなトランザクションのまとまりに対してゼロ知識証明を用いて暗号学的な証明を作る取り組みです。Ethereumのノードは、EVMの全てのトランザクションを検証しなければならず、新たに加えられたノードも全てのトランザクションを検証する必要があるためネットワークが成長するとともに新しいノードが必要な作業も増加します。そのためEthereumのブロックに対して証明を生成することでこの作業量の増加に対処します。

`Writer: @ashWhiteHat`

# ZkEvmとは何か？

Ethereumのブロックチェーンで実現されている機能性をスケーラブルにする取り組みであり、以下のどれかに該当する

- ZK-SNARKを用いてEthereumでサポートされているようなトランザクションに暗号学的な証明を作る
- Ethereum自体の検証より簡単にする
- Ethereumが提供している機能と同じかそれに近い機能にZK-Rollupsを構築する

これらのプロジェクトは実現可能性と速度のトレードオフによって異なっている。  
ZkEvmは利便性とコストの観点から4つの型に分けることができる。

![型](./img/types.png)

## 型1（Ethereum完全互換）

この型は、Ethereumとの完全互換を目指している。  
証明生成を簡単にするためにEthereumのシステムを変更しない。  
以下に付随的なものであってもハッシュ関数やステートツリーやトランザクション手数料、プレコンパイルやコンセンサスに関わる機能を置き換えることはしない。

**メリット：完全互換**
目標は、現在のEthereumのブロックの検証を可能にしすることである。  
究極的にはEthereumのL1をよりスケーラブルにするために必要なことであり、長期においては他の型での実装によってEthereumを再設計する可能性もある。  
この型1は様々なインフラに用いることができるため理想的なロールアップである。  
ブロックチェーンエクスプローラなどのEthereumのエコシステムのツールを簡単に使い回すことができる。

**デメリット：長い証明生成時間**
Ethereumは元々、ゼロ知識証明を前提として設計されたものではないためゼロ知識証明の証明の生成に多くの時間がかかってしまう。  
型1は、Ethereumの完全互換を目的としているため非効率性を受け入れるしかない。  
現時点では、Ethereumブロックへの証明には数時間かかる。  
証明生成の並列化や長期ではZK-SNARKの仕様によって改善される。

**プロジェクト**
- [Privacy and Scaling Explorations](https://github.com/privacy-scaling-explorations/zkevm-circuits)
- [Taiko](https://taiko.xyz/)

## 型2（EVM完全互換）

この型は、EthereumではなくEVMとの完全互換を目指している。  
内部からはEthereumのように見えるが、外部にはブロック構造やステートツリーなどに違いがある。  
目標は既存のアプリケーションとの完全互換であるが、開発工数短縮や証明生成の簡易化のためEthereumに微修正を加えている。

**メリット：VMレベルでの完全互換**
型2は、Ethereumの状態を保持するデータ構造に変更を加えている。  
しかし、それらのデータ構造にはEVMから直接アクセスすることはできないためほとんどのアプリケーションと互換性がある。  
Ethererumの実行クライアントをそのまま使うことはできないが、少し修正を加えることで使うことができる。  
EVMの開発環境やその他のエコシステムはこれまでと同じように使うことができる。

例外として、ハッシュ関数が効率の良いものに変更されているため、従来のブリッジなどで用いられるブロックのマークルツリーを検証し、過去のトランザクションやステートを検証することはできない。

**デメリット：少し改善されたが長い証明生成時間が必要**
型2は、Ethereumの不要な箇所やゼロ知識証明に適していない要素を取り除くことで型1より速い証明生成を実現した。  
具体的には、KeccakハッシュやRLPを使ったマークルパトリシアツリー、ブロックやトランザクションレシートの構造など。  
型2は、ポセイドンハッシュというゼロ知識証明に適したハッシュ関数を用いているため、Keccakハッシュに関する`EXTCODEHASH`や`EXTCODECOPY`などのオペコードは置き換えられている。

これらの変更によって証明生成にかかる時間を大きく削減したが、EVM自体の証明にはゼロ知識証明に適していない箇所が存在し、いまだに長い証明時間が必要。

**プロジェクト**
- [Scroll](https://scroll.mirror.xyz/)
- [Polygon Hermez](https://hermez.io/)

どちらのプロジェクトも現時点ではプレコンパイルなどの複雑な箇所は実装されていないため型3と考える方が妥当である。

## 型2.5



# 参照

- [The different types of ZK-EVMs](https://vitalik.eth.limo/general/2022/08/04/zkevm.html)
