# マイニングとコンセンサス

## 概要

- ブロックチェーンは改ざんできないことはわかったが、新しいブロックに含まれる情報がなぜ正しいものがはいるのか、その正しさはどのように全体でコンセンサスを得るのかをここで説明する

- 合意のプロセス

  - [分散化コンセンサス](#分散化コンセンサス)

- トランザクション検証
  - [独立したトランザクション検証](#独立したトランザクション検証)
  - [マイニングノード](#マイニングノード)
  - [ブロックへのトランザクション集積](#ブロックへのトランザクション集積)
  - [トランザクション手数料](#トランザクション手数料)
  - [Coinbase トランザクション概要](Coinbaseトランザクション概要)
- マイニング
  - [マイニング報酬と手数料](#マイニング報酬と手数料)
  - [Coinbase トランザクションの構造](#coinbaseトランザクションの構造)
  - [ブロックヘッダの構築](#ブロックヘッダの構築)
  - [ブロックのマイニングー Proof-of-Work アルゴリズム](#ブロックのマイニングーproof-of-workアルゴリズム)
  - [マイニングのプログラム例](#マイニングのプログラム例)
  - [difficulty ターゲットの表現](#difficultyターゲットの表現)
  - [difficulty ターゲットの更新](#difficultyターゲットの更新)
  - [マイニングに成功したら](#マイニングに成功したら)
- ブロック検証
  - [新しいブロックの検証](#新しいブロックの検証)
  - [ブロックのチェーンの組み立てと選択](#ブロックのチェーンの組み立てと選択)
  - [ブロックチェーンフォーク](#ブロックチェーンフォーク)
  - [マイニングとハッシュ化競争](#マイニングとハッシュ化競争)
  - [マイニングプール](#マイニングプール)
  - [コンセンサス攻撃](#コンセンサス攻撃)

## 分散型コンセンサスの基礎

分散型コンセンサスは、中央管理者が存在しない状況で、ネットワーク上の全参加者が共通の合意に達するためのプロセスである。このプロセスは、ブロックチェーン技術の核心部分を形成し、ビットコインを含む多くの仮想通貨の基盤となっている。


- コンセンサスアルゴリズムの種類
分散型コンセンサスを実現するためには、様々なコンセンサスアルゴリズムが存在する。主なものには以下がある。

- Paxos：分散システムにおける合意形成のためのアルゴリズムの理論を築いたモデル。
- Raft：Paxosよりも理解しやすいことを目指した合意形成アルゴリズム。
- PBFT（Practical Byzantine Fault Tolerance）：ビザンチン障害に耐えることができるアルゴリズム。
- PoW（Proof of Work）：計算問題を解くことで合意形成を行うアルゴリズム。ビットコイン等で使用されている。
- PoS（Proof of Stake）：保有している通貨の量に基づいて合意形成を行うアルゴリズム。Ethereum等で使用されている。


- 中央管理者なしでの真実と合意の形成

分散型コンセンサスでは、中央管理者がいないため、ネットワーク上の各参加者が独立して動作し、全体として最適に動くことが求められる。このプロセスは以下の4つの相互作用で成り立つ。

1.  独立したトランザクション検証
    ビットコインネットワークでは、すべてのフルノードがトランザクションを検証する。この検証プロセスは、ネットワーク上で共有されている包括的なトランザクションリストに基づいて行われる。各ノードは、このリストに従ってトランザクションが正しいかどうかを独立して判断し、その結果を他のノードと共有する。このプロセスにより、ネットワーク全体でトランザクションの正当性が確認される。

2.  独立したトランザクション集積
    トランザクションが検証された後、マイニングノードはこれらのトランザクションをブロックに集積する。このプロセスはProof of Work（PoW）アルゴリズムによって支えられており、マイニングノードは計算問題を解くことで新しいブロックを生成する権利を得る。マイニングノードは、自らが解いた計算問題に基づいて、トランザクションをブロックに追加することができる。

3.  独立した新規ブロック検証とブロックチェーンへの埋め込み
    新しいブロックがマイニングノードによって提案されると、ネットワーク上のすべてのノードはそのブロックを検証する。この検証に成功すると、各ノードは新しいブロックを自身が保持するブロックチェーンに追加する。これにより、ネットワーク全体でのデータの一貫性が保たれる。

4.  独立したブロックチェーン選択
    ビットコインネットワークでは、複数のブロックチェーンが同時に存在することがある。この場合、各ノードはPoWを通じて証明された、最も多くの累積計算量を持つブロックチェーンを選択する。これにより、最も長いブロックチェーンが正当なものとして認識され、ネットワーク全体での合意が形成される。

- なぜコンセンサスの創発と呼ばれるのか
  Bitcoin のコンセンサスの流れ：マイナーが主張している内容を、各ノードが検証し、ノード全体の合意という形でその内容は認証される
  このコンセンサスは、全参加者により常に行われている検証によって創り出されている。このような方法によるコンセンサスは、創発的（emergent）コンセンサスと呼ばれる。
  このコンセンサスの方式が、情報の信頼性を保証する別の仕組み、PKI(公開鍵基盤)と最も違う点である。
  PKI は、信頼できる第三者を利用して「事実の主張」を確認する手段である。PKI では，主体が主張している内容を認証局などが確認のうえで事実として承認し、電子署名によって認証していた。

## 独立したトランザクション検証

- ビットコインネットワークでは、各ノードがトランザクションを独立して検証する。この検証プロセスは、不正なトランザクションがネットワークに広がるのを防ぐ。主な検証ポイントは以下の通り。

1. 二重支払いの防止
各トランザクションのインプットが過去に支払われていないことを確認する。これにより、一度使われたビットコインが再度使用されることを防ぐ。

2. 新たなビットコインの生成防止
トランザクションのインプットの合計額がアウトプットの合計額以上であることを確認する。これにより、許可されていない新たなビットコインの生成を防ぐ。

3. 署名の検証
トランザクションに含まれる署名が有効であることを確認する。これにより、トランザクションの正当性を保証する。

- トランザクションがネットワークに送信されると、以下の手順で検証される。

- インプットの存在と使用状況の確認
  ノードは、各インプットが未使用のトランザクション出力（UTXO）であることを確認する。

1. 二重支払い防止のため、ノードは各インプットが存在すること及び過去に使われてないことを確認する(UTXO セットにアクセスし、UTXO を追跡することであるインプットが二重支払いかどうか検証可能)
2. UTXO は Unspent Transaction Outputs の略。インプットに未だに払われていないものが入っていなければ、二重支払いであるということが判明する。

- インプットの合計額とアウトプットの合計額の確認
 インプットの合計額がアウトプットの合計額を上回っているかを検証する。

1. ノードはインプットの合計がアウトプットの合計以上であることも確認する(これによりトランザクションが新たなコインを作成することを防ぐ)(後述する coinbase トランザクションは例外)

- 署名の確認
  トランザクションの各インプットに対して、適切な署名が存在するかを確認する。

1. トランザクションは通常は 1 インプットにつき少なくとも 1 つ以上の署名を持つ。ここで署名ハッシュを取得する部分において、署名は ScriptSig の一部であるためにトランザクションのシリアライズをハッシュすることができない(署名は ScriptSig の一部であり、署名自体に署名できないから)
2. 代わりに、インプットごとに異なる署名ハッシュを計算する(署名前にトランザクションを変更する)
3. 全ての ScriptSig を空にする
4. 署名されるインプットの ScriptSig を前の ScriptPubKey に置き換える
5. ハッシュタイプを付加する(4 バイトのハッシュタイプを末尾に加えることで署名が正当性を認める内容を指定する)

- このような手順を踏むことでトランザクション検証プロセスが行われる。署名ハッシュのアルゴリズム自体は非効率的で無駄が多いため、Segwit 以降は所謂二次ハッシュ問題は別手法により解決されている

その他の補足説明

- インプットのいずれも hash=0, N=-1 でないか(coinbase トランザクションでないか)
  - coinbase トランザクションは新しく生成されたビットコインと、ブロックを採掘することによって得られるトランザクション手数料を採掘者（マイナー）に報酬として与える特別なトランザクション。
  - トランザクション ID（TxID）が全て 0 で、過去のトランザクションを参照しないことを意味し、出力インデックス（vout）が-1 となる。
- nLockTime は INT_MAX 以下か
  - nLockTime は、トランザクションを遅延させる時間やブロックの高さを示している。トランザクションが意図した時間やブロック高さまで正しく遅延されるように確認している。
  - LockTime は発行されたトランザクションがチェーン上に保存される前に、それを他のノードが確認することを可能にする。LockTime を長くすると、そのトランザクションがよく伝播した上でチェーンに追加されるので、フォークが減る一方、コンセンサスの時間がかかる事になる。
- オーファントランザクションとは
  - オーファントランザクション（Orphan Transaction）は、ビットコインネットワークにおいて、その入力となるトランザクション（親トランザクション）がまだネットワークに認識されていない、あるいは利用可能なブロックチェーンの履歴に含まれていないトランザクションを指す
  - オーファントランザクションは、ビットコインネットワーク上でトランザクションが非順序で伝播するときに発生することがある。
  - 近年では、ビットコインのプロトコルや実装の改善により、オーファントランザクションが発生する頻度は減少している。
- なぜトランザクション手数料が少なすぎるといけないのか
  - スパム攻撃の防止
    - ネットワークを圧迫し、正当なトランザクションの処理を遅くすることができる
  - 手数料はマイナーにとっての貴重な収入源
    - ネットワークを維持するインセンティブになるので、低すぎない手数料でないと却下する。
- 各インプットのアンロッキングスクリプトは，対応したアウトプットのロッキングスクリプトを解除できるか．
  - ロッキングスクリプトは、トランザクションのアウトプットに配置され、その資金が使用される条件を定義する
  - アンロッキングスクリプトは、トランザクションのインプットに含まれ、対応するアウトプットのロッキングスクリプトに設定された条件を満たすために使用される tt
- COINBASE_MATURITY(100)

  - COINBASE_MATURITY とは、coinbase トランザクションによって生成されたビットコイン）が使えるようになるまでの承認の数である
  - ビットコインの場合、その値は 100 であり、ビットコインが採掘されてから、そのビットコインを使って他のトランザクションを行うことができるようになるまで、約 100 ブロック分（約 16 時間 40 分から 17 時間）の時間が必要。
  - 二重支払いを防ぐ
    - 採掘者が一時的に生成したブロックを使ってトランザクションを実行し、その後にそのブロックがオーファン（孤立）ブロックとなった場合、ビットコインは事実上二重で使われることになってしまう。
  - ネットワークの安定性確保
    - チェーンに保存されることが確定するまで時間をおくことができる。
  - ビットコインの価格が急激に変動するのを防ぐ。

- その他のコンセンサス
  - PBFT - コンソーシアム型むきのコンセンサスアルゴリズム。ノードが小規模かつ、固定されている時向け。リーダーが Validating peer に対して Tx を正しく送ったことを信頼している - 長所 - Tx を実行する権限が、プライマリーノードしかないため、トランザクションに分岐が発生せず、履歴が覆ることがない - 短所 - 基本的に、ノードを信頼しないといけない - 一つの機械、ノードが一つの vote なので、一定数を超えた悪意があるものがいれば、コンセンサスは止まる - スケーラビリティ：PBFT の効率は、ネットワーク内のノードの数に強く依存します。ノード数が増加すると、必要なメッセージの数が指数関数的に増加し、ネットワークの遅延と帯域幅の使用が大幅に増加します。これは、大規模なネットワークでの使用を困難にします。 - vertual machine software にアクセスした 1 人が（承認されれば）ノードをいくらでも増やせるようになっていた

## マイニングノード

- マイニングノードの役割
  マイニングノード、またはマイナーと呼ばれるこれらのノードは、Proof of Work（PoW）という計算問題を解くことによって新しいブロックを発見する。このプロセスは「マイニング」と呼ばれ、以下のように進行する。

1. ブロックの発見: マイナーはPoW問題を解くことにより、新しいブロックを発見する。この問題を最初に解くことができたマイナーは、新しいブロックをブロックチェーンに追加する権利を得る。
2. 報酬の獲得: ブロックをブロックチェーンに追加すると、マイナーは新たに生成されたビットコイン（ブロック報酬）と、そのブロックに含まれる全てのトランザクション手数料を報酬として受け取る。
3. ブロックの検証: 他のノードは新しく追加されたブロックを検証し、その結果に基づいてブロックチェーンに組み込むかどうかを決定する。検証に失敗したブロックはチェーンに取り込まれない。


- マイニングノードは、必ずしもフルノードでなくともよい。
  - マイニングプールではフルノードなしにマイニングする
  - 一般的には、フルノードとなりすべてブロックの検証が可能な状態のブロックチェーンに対してマイニングする

- 一時的分岐の発生と解決
  ブロックチェーンにおいては、複数のマイナーがほぼ同時に新しいブロックを見つけた場合、一時的にブロックチェーンが分岐することがある。この現象を「一時的分岐」と呼ぶ。分岐したチェーンのうち、最終的に最長のチェーンが正当なものとして採用され、他のチェーンは放棄される。この選択プロセスは以下のように進行する。
  マイナーは受け取った最初の有効なブロックを基にマイニングを続ける。
  新たなブロックが追加されることで、一方のチェーンが他方よりも長くなる。
  ネットワークの他のノードも最長のチェーンを正と認識し、短いチェーンのブロックは無視される。
  このメカニズムにより、ブロックチェーンは一貫性を保ち、ネットワーク全体での合意が形成される。マイニングはブロックチェーンのセキュリティと透明性を保つために不可欠であり、ビットコインシステムの根幹をなす要素である。

## ブロックへのトランザクション集積

トランザクションの確定を保証するプロセスとして、ネットワークのセキュリティを維持する必要がある。

- マイニングノードは候補ブロックを作る

  - 次の新しいブロックとしてトランザクションのリストを持ったブロック

    - ブロックのヘッダには、前のブロックのハッシュ、タイムスタンプ、ナンス値、難易度ターゲットなどの情報が含まれる。

- トランザクションは自身のトランザクションプールから選ぶ

  - ここにはそのノードが受け取ったがまだブロックチェーンに取り込まれていないトランザクションが格納される。他のノードのトランザクションプールとは異なることがある。

- 候補ブロックのナンス値を見つける（PoW）(ナンス値はマイナーが PoW を探す際に変更される)

  - これはマイニングの難易度（難易度ターゲット）によって変化する。

- 候補ブロックに入れるトランザクションは優先度が決められる

  - 手数料、CoinAgePriority(今は使われていない)などがある。

- ブロックサイズとトランザクション容量

  - ブロックのサイズには上限がある。現在は 1MB の基本ブロックサイズに加えて、SegWit による拡張部分があり、倍程度になっている。

出典・参考
https://tottemoyasashiibitcoin.net/entry/2016/12/01/215608
https://xtech.nikkei.com/atcl/nxt/column/18/02132/082900006/#:~:text=Bitcoin%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AF1,%E5%BD%93%E3%81%9F%E3%82%8A7%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E3%81%AA%E3%82%8B%E3%80%82
https://gaiax-blockchain.com/segwit#:~:text=Segwit%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E4%BB%A5%E4%B8%8B%E3%81%AE%E5%BC%8F,%E5%BC%8F%E3%81%8C%E5%B0%8E%E5%85%A5%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82&text=%E5%BE%93%E6%9D%A5%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF,%E6%A0%BC%E7%B4%8D%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82

## トランザクション手数料

- トランザクション優先度はトランザクションサイズと手数料、Age から計算される．

  - ノードが受け取れる手数料を多くする．

  - 1MB というブロックサイズに入れられるだけのトランザクションを入れる

  - 古い UTXO から使用される

- 最初の 50KB

  - Priority に従ったトランザクション
  - Priority = Sum (Value of Input \* Input Age) / Transaction Size
    - Value of Input ・・・ Input を単位 satoshi で．（1BTC=1 億 satoshi）
    - Input Age ・・・ Input の UTXO が含まれるブロックから現在のブロック高の差

- 残り
  - トランザクション手数料をデータサイズで割った順

※ 上記は過去、トランザクションが少なかった頃採用されていたルールの様子。現在はすべてトランザクション手数料を見て判断されている

- トランザクション手数料の意義

  - そもそもマイナーにはブロックを小さく保とうとする明確な動機が存在する(ブロックにトランザクションを追加すればするほど、ブロックを伝播する時間が長くなり、他のマイナーによって次のブロックが先に見つかるリスクが増え、ブロック間のマイニング競争で不利になる)
  - しかしながら、ブロックにトランザクションを追加するたびにマイナーが得る収入が増えるとすると、マイナーの競争力の低下を補うインセンティブが発生する
  - これはあくまでひとつの説明だが、実際に効力をなしている

- Bitcoin のトランザクション手数料の計算方法
  トランザクションサイズ（バイト）によって決定される。（送金する額ではない）

  - このレート（e.g. 80 satoshi/バイト）は送金需要を反映して上下する。
  - これが高すぎるとき、Bitcoin は日常的な決済に向かなくなる。
  - 手数料を低くしたいが、そこにスケーラビリティ問題が発生している。

- ビットコインのコンセンサスルールのひとつに、任意の非 coinbase トランザクションにおいてはインプットの合計 ≧ アウトプットの合計というものがある。トランザクションのコストがゼロであるならば、マイナーがトランザクションをブロックに取り込むインセンティブがなくなるから

  - 手数料はマイナーがトランザクションをブロックに含める動機になる、故に高い手数料は早い処理速度に繋がる。

- このように、インセンティブ設計ひとつ取っても中央管理者抜きでビットコインシステムが成り立つ基盤となっている

- 元々は Coin Age Priority というトランザクションの手数料と優先度を定めたロジックが存在したが、今はない。現在では、トランザクションを早く通す(早くブロックに取り込まれる)ためにはいくつかの要因があるが、手数料の支払い額が優先度の大きな判断基準となっている

  - その優先度に従って候補ブロックに入れるトランザクションが決められる。
  - 現在はトランザクションの選択は主に手数料に基づいている。
  - 以前は手数料に加えて、Coin Age Priority（トランザクションに含まれるビットコインが最後に動いた時間）に基づいていた。

- ブロック報酬が時間とともに半減していく中で、トランザクション手数料はマイナーにとってますます重要な収入源となる。これは、ビットコインネットワークが長期的に持続可能であるための基盤となる。

出典・参考
https://academy.binance.com/ja/articles/what-are-blockchain-transaction-fees

## Coinbase トランザクション概要

- 各ブロックの最初に要求されるトランザクションを coinbase トランザクションもしくは generation トランザクションと呼ぶ。

- マイナー自身への支払いとなる、ブロック内の他のトランザクションの全ての手数料とブロック報酬が含まれる

- インプットは coinbase と呼ばれるデータ領域になっている

  - マイニング報酬は無から生み出される、すなわち対応する UTXO はない
  - その代わりにこの特別なデータ領域に任意のデータを含めることができる（しばしば、マイニングプールやその他のメッセージが含まれる）
  - エクストラナンスとしても使用される -エクストラナンスは、マイナーがナンス値の範囲(32bit, 2^32 通り)を超えて計算を続けることを可能にするための追加のパラメータ

- アウトプットはマイナーのアドレスへ（Coinbase のロッキングスクリプトは、マイナーが報酬を支払いに使用できるようにするために、公開鍵を基にしたものとなっている）

  - Coinbase トランザクションがマイナーに対してブロック報酬(マイニング報酬)を支払うという構造

- マイニング報酬とブロック報酬の違い
  - 「マイニング報酬」はマイニング活動から得られる全体的な報酬を指す（広範に用いられる）、
  - 「ブロック報酬」はその中の特定の部分、すなわち新しいブロックを発見した際にマイナーに与えられる特定の報酬（新規コインとトランザクション手数料の合計）を指すと考えられる。

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/glossary.asciidoc#L27
https://medium.com/fcats-blockchain-incubator/understanding-the-bitcoin-blockchain-header-a2b0db06b515
https://scrapbox.io/chaintope/ExtraNonce_%E3%81%A8%E3%81%AF%E3%81%AA%E3%81%AB%E3%81%8B
https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch12_mining.adoc

## マイニング報酬と手数料

- マイニング成功時に得られる報酬は、マイニング報酬＋手数料

- マイニング報酬

  - マイニング報酬とはすなわちビットコインの新規発行

  - 210,000 ブロックごとに報酬は半減する

  - 約 4 年、1 ブロック=10 分

  - 最初 50BTC で、2020 年 5 月には 6.25BTC になった

  - 2024/01 現在 1BTC≒600 万円なので約 3,700 万円

  - 最終的にマイニング報酬が 0 になるのは 2140 年ごろ、そのころになると 1satoshi を切る。そのとき総発行量は 2100 万 BTC となる

- マイニング報酬の目的

  - マイナーは計算問題を解くことでトランザクションを検証し、新しいブロックをブロックチェーンに追加する。このプロセスにより、不正行為やダブルスペンディングを防ぐことが可能になっている

  - マイナーに、マイニングを通して、ビットコインネットワークのセキュリティと整合性を保つよう促すためのもの。

- 半減期に関連する経済用語

  - デフレーション効果

    - 物価の下落が消費者や企業の行動に与える影響のことで、物価が下がることで消費者の購買力が増す一方で、将来的にさらに価格が下がると予想されるため、消費が抑制される可能性もある。

  - 希少価値

    - あるものが希少であることから生じる価値のこと。

  - 供給制限

    - モノやサービスの需要に対し、人手不足や物流の停滞などで供給が追いつかないこと

- 手数料

  - Total Fees = Sum(Inputs) – Sum(Outputs)

  - ブロック内に入れるトランザクション全体の手数料総和

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch12_mining.adoc#L72
https://www.coinex.com/ja/blog/3270-what-is-issuarance-limit
https://plisio.net/ja/blog/what-is-bitcoin-halving

## Coinbase トランザクションの構造

- インプットは必ず一つのみ、その一つのインプットの前のトランザクション ID は 32 バイトの 00 である、その一つのインプットの前のトランザクションインデックスは ffffffff である、という 3 つの条件が coinbase トランザクションか否かを決定づける

- Coinbase トランザクションのインプットはアンロッキングスクリプトの代わりに任意のデータを入れられる

  - Genesis ブロックの新聞見出し

  - 2 バイト～ 100 バイト

- 最初にブロック高を入れ、そのあとは任意のデータ

  - 後述するように、エキストラナンスとしても使用される

- コインベーストランザクションインプットは以下のフィールドを含む：

  - トランザクションハッシュ（32 バイト）: すべてのビットがゼロで、トランザクションハッシュへの参照ではない

  - アウトプットインデックス（4 バイト）: すべてのビットが 1 で、0xFFFFFFFF（※）

  - コインベースデータサイズ（1 ～ 9 バイトの VarInt）: コインベースデータの長さで、2 から 100 バイトの間

  - コインベースデータ（可変長）: エキストラナンスやマイニングタグに使用される任意のデータ。v2 ブロックではブロック高で始まる

  - シーケンス番号（4 バイト）: 0xFFFFFFFF（※）

    - ※コインベーストランザクションはブロックの最初のトランザクションであり、新たに生成されたビットコインとトランザクション手数料をマイナーに報酬として与えるために存在する。この特殊なインデックス値を使用することで、システムはこのトランザクションが特定の UTXO を参照していないことを認識できる。

    - 他にも特定のブロックがマイニングされた時点の情報を残すために使用されることもある

      - e.g. サトシ・ナカモトがジェネシスブロックのコインベーストランザクションに含めた文章

      - The Times 03/Jan/2009 Chancellor on brink of second bailout for banks

- 通常のトランザクションインプットは、以下のフィールドから構成される：

  - トランザクションハッシュ（32 バイト）: 使用する UTXO を含むトランザクションへのポインター。

  - アウトプットインデックス（4 バイト）: 使用される UTXO のインデックス番号。

  - アンロッキングスクリプトサイズ（1 ～ 9 バイトの VarInt）: アンロッキングスクリプトの長さをバイト数で示している。

  - アンロッキングスクリプト（可変長）: UTXO のロッキングスクリプトの条件を満たすスクリプト。

  - シーケンス番号（4 バイト）: 通常は BIP 125 と BIP 68 からのオプトアウトを示すために 0xFFFFFFFF に設定される。

    - BIP 125（トランザクションのリプレース可能性に関する規則）および BIP 68（相対ロックタイムの導入）をオプトアウトする理由

    - BIP 125 をオプトアウトすることで、トランザクションの置き換えを防ぎ、ネットワークの混雑時にトランザクションが確実に処理されるようにすることができる。

    - BIP 68 をオプトアウトすることで、特定のトランザクションに対して相対ロックタイムの制約を適用しないことを選択し、即時処理を優先させることが可能になる。

      - 相対ロックタイムは、特定のトランザクションが特定のブロック数または時間が経過するまで消費されないようにする。

出典・参考
https://cointelegraph.com/explained/what-is-a-coinbase-transaction
https://learn.saylor.org/mod/book/view.php?id=36375&chapterid=19427#:~:text=In%20a%20coinbase%20transaction%2C%20the,to%200xFF%20(255%20decimal)
https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki
https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki

## ブロックヘッダの構築

- ブロックヘッダはブロックに含まれるトランザクションに関するメタデータ

- マイニングに成功した場合、ブロックヘッダを構築する必要がある

  - 普通のブロックヘッダ

  - マイナーが作成

  - 間違えると無効になって報酬が損するので間違えないように作成する必要がある

- Target PoW の Difficulty Target

- Nonce マイニングで求める値。マイナーが PoW を探す際に変更される

| Size     | Field               | Description                                                          |
| -------- | ------------------- | -------------------------------------------------------------------- |
| 4 bytes  | Version             | A version number to track software/protocol upgrades.                |
| 32 bytes | Previous Block Hash | A reference to the hash of the previous (parent) block in the chain. |
| 32 bytes | Merkle Root         | A hash of the root of the merkle tree of this block’s transaction.   |
| 4 bytes  | Timestamp           | The approximate creation time of the block.                          |
| 4 bytes  | Difficulty Target   | The proof of work algorithm difficulty target for this block.        |
| 4 bytes  | Nonce               | A counter used for the proof of work algorithm.                      |

- Difficulty target の計算式 difficulty = difficulty_1_target / current_target の difficulty_1_target には bdiff と pdiff がある
  - 相違点
    - bdiff(block difficulty)
      - ビットコインプロトコルがターゲットを表現するために使用するカスタムの浮動小数点型
      - ブロック生成が平均して 10 分に 1 回となるように調整されている
    - pdiff(pool difficulty)
      - マイニングプール内での相対的な難易度を示す
      - 通常は 0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
    - 例えば current*target = 0x1b0404cb(0x0404cb * 2\*\*(8\_(0x1b - 3)))のそれぞれの難易度は、
      - bdiff:
        - 0x00000000FFFF0000000000000000000000000000000000000000000000000000 /0x00000000000404CB000000000000000000000000000000000000000000000000 = 16307.420938523983
      - pdiff:
        - 0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF /0x00000000000404CB000000000000000000000000000000000000000000000000 = 16307.669773817162
  - Bitcoin ではないが ldiff もある
    - ldiff は、全体の Litecoin(BTC のサブアセット)ネットワークのターゲット難易度を示す

出典・参考
https://learn.saylor.org/mod/book/view.php?id=36375&chapterid=18988
https://en.bitcoin.it/wiki/Difficulty
https://stackoverflow.com/questions/52972514/where-and-how-pool-difficultypdiff-is-set-in-bitcoin-source-code
https://bitcoin.stackexchange.com/questions/24349/in-pooled-mining-what-is-pdiff-bdiff-and-ldiff

## ブロックのマイニングー Proof-of-Work アルゴリズム

- マイニング：ブロックにおけるディフィカルティの条件を満たすナンスを求める（ヘッダの中にはナンスも入っていて，それ以外の部分を確定の上でナンスを求める）

- トランザクションリストを選び、ブロックヘッダを構築したら、候補ブロックに対してあとはやることはマイニングのみ

  - トランザクションリストを選び，ブロックヘッダのナンス値以外の箇所を確定させたら、候補ブロックに対してマイニングを行う。

    - トランザクションリスト

      - 送信者、受信者、送金額などの情報を含む

  - ブロックヘッダ

    - ブロックを識別するための情報

    - バージョン情報、タイムスタンプ、直前のブロックのハッシュ値、マイニング報酬のアドレスなど

    - ここを改ざんされると、それ以降の全てのブロックも改ざんされてしまう（そのため、ハッシュ値と難易度により改ざんの検知を可能にしている）

- ナンス値(4 bytes)を発見する

  - ブロックヘッダに追加されるランダムな値

  - マイニングの難易度調整に使用される

  - 異なるナンス値によって、ブロックハッシュ値が変化する

- ブロックハッシュの頭にゼロがいくつか並ぶもとの文字列を求める

  - ブロックヘッダのダブルハッシュ値(SHA256 2 回)

  - セキュリティを高め、コンフリクト(ハッシュ関数の入力が異なるが、同じ出力値が生成されること)する可能性を下げる

- ゼロがいくつ必要かはその時点のターゲットによる

- ハッシュ値がターゲット未満になるようなナンス値を探す

  - 例えば
  - 0x0000000000000003A30C00000000000000000000000000000000000000000000
  - というターゲットの場合、ブロックハッシュの値がこの値より小さい必要がある

- ナンス（4bytes）だけではターゲットを越えるには少なすぎる

  - 4 バイト整数の最大値は約 43 億
  - 0x0000000000000003A30C00000000000000000000000000000000000000000000
  - の例だと先頭 7 バイトが 0 になる．ということは解の候補は 256^(32-7)
  - ハッシュ値一個につき，解の候補に該当する確率は 256^(32-7) /(256^32)= 1/72,057,594,037,927,900
  - 2024/03 時点で最新のブロックのブロックハッシュを見ると先頭 19 バイトが 0 となっていた
  - そうすると(256^13)/(2^256)=1/(2^152)
  - 期待値では 2^152 回のナンス値の試行をする事になる(2^149byte)
  - 設計当初の想定よりも難易度が高くなっていることを示している

出典・参考
https://en.bitcoin.it/wiki/Protocol_documentation#Block_Headers
https://en.bitcoin.it/wiki/Proof_of_work

## マイニングのプログラム例

- ナンス値を変えてブロックハッシュを求めてターゲット以下になるか、ということを繰り返して行う以外方法がない

  - ハッシュ関数は不可逆で、元の値を少しでも変えるとハッシュ値は大幅に変わる

- Python の実装例：

```python
def proof_of_work(difficulty):
    # nonceは4byte
    for nonce in range(2 ** (4 * 8)):
        header = get_header(nonce)
        blockhash = double_hash(header)
        if blockhash < difficulty:
            return nonce
    raise NotFoundException()
```

- PoW のターゲット

  - bool CheckProofOfWork(uint256 hash, unsigned int nBits, const Consensus::Params& params)
    {
    bool fNegative;
    bool fOverflow;
    arith_uint256 bnTarget;
    bnTarget.SetCompact(nBits, &fNegative, &fOverflow);
    // Check range
    if (fNegative || bnTarget == 0 || fOverflow || bnTarget > UintToArith256(params.powLimit))
    return false;
    // Check proof of work matches claimed amount
    if (UintToArith256(hash) > bnTarget)
    return false;
    return true;
    }

- 4 バイトのナンス値（nonce）を 0 から 2^32-1 までループ

- ナンス値とその他のヘッダ情報からブロックヘッダを生成

- ブロックヘッダをハッシュ関数に２回通してブロックハッシュを計算

- ブロックハッシュとターゲット値を比較

- ブロックハッシュがターゲット値より小さい場合、ナンス値を返す

- ターゲット値より大きい場合は、ループを継続

- 2^32 回のループ後もターゲット値以下にならなかった場合、NotFoundException を発生

出典・参考
https://github.com/bitcoin/bitcoin/blob/98005b6a17907c4f7bdcf802ee96c274492f902a/src/pow.cpp#L125

## difficulty ターゲットの表現

- Difficulty をチェックすることで、マイニングの活性度を確認できるほか、現在獲得可能な「マイニング報酬」が割安か、割高かの目安にすることができる

- Difficulty target はヘッダに含まれる

  - 4 Bytes

  - 小さいほど難易度が高く、大きいほど難易度が低い

  - 16 進で、初めの 1 バイトが指数(exponent)、残りの 3 バイトが係数(coefficient)

- target = coefficient _ 2 ^ (8_(exponent-3)) で表される

- 0x1903a30c なら

  - target = 0x03a30c _ 20x08_(0x19-0x03)

  - target = 0x03a30c * 2(0x08*0x16)

  - target = 238,348 * 28*22

  - target = 238,348 \* 2176

  - target = 22,829,202,948,393,929,850,749,706,076,701,368,331,072,452,018,388,575,715,328

  - target = 0x0000000000000003A30C00000000000000000000000000000000000000000000

出典・参考
https://en.bitcoin.it/wiki/Difficulty
https://coinpost.jp/?p=263918

## difficulty ターゲットの更新

- ブロック生成時間が 10 分に保たれるようにターゲットが一定間隔で調整される

- 「10 分」という間隔は、何十年にもわたって保ちたい

  - コンピュータの急激な進化にも耐えられるようにする

  - マイニング参加者、コンピュータ台数も変化する

  - 短すぎる生成間隔はオーファンレートの増加を引き起こし、長すぎるとトランザクションの確定待ち時間が不便になる

- ターゲットはブロックが 10 分間隔で生成されるように２週間ごと（2016 ブロックごと）に調整される

> New Target = Old Target \* (Actual Time of Last 2016 Blocks / 20160 minutes)

- New Target: 新しい難易度ターゲット
- Old Target: 古い難易度ターゲット
- Actual Time of Last 2016 Blocks: 過去 2016 ブロックの生成時間
- 20160 minutes: 2 週間分の時間（10 分/ブロック \* 2016 ブロック）

- ターゲットが極端に動きすぎないように、調整の際、最大 4 倍、最小で 1/4 以内になるようになっている

出典・参考
https://en.bitcoin.it/wiki/Difficulty

## マイニングに成功したら

- 候補ブロックが正しい新しいブロックとして生成できたということになる

- これは、いち早く他のノードに伝搬すべき

  - 他のマイナーも同時期にマイニングに成功している可能性があり、そちらが採用されてし
    まうと自分のマイニングしたブロックが無効になってしまうため
  - もらえるはずだった報酬がもらえなくなってしまう

- どうやって伝搬させるのか？

  - ピアに送信する
    - ピアはそれを受け取り、検証し、コピーして増やす
    - そのピアがマイニングノードと違うネットワークに所属していれば、そのブロックチェーンにブロックをコピーし繋げる。
  - プロトコルは？
    - TCP/IP プロトコルにて使う(ping pong message にて維持する)
    - メッセージヘッダについて
      - メッセージヘッダの形式は以下の通り
        - 4 バイト: 開始文字列 (char[4])
          - ネットワークの種類を示すマジックバイト
          - その転送データの状態が未知の時点 f で次のメッセージを探すために使用される
        - 12 バイト: コマンド名 (char[12])
          - ペイロードに含まれるメッセージタイプを識別する ASCII 文字列
          - ヌル文字 (0x00) でパディングされる
          - 例: version\0\0\0\0\0
        - 4 バイト: ペイロードサイズ (uint32_t)
          - ペイロードのバイト数
          - BitcoinCore で許可される現在の最大バイト数 (MAX_SIZE) は 32MiB で、これを超えるとメッセージは破棄または拒否される
        - 4 バイト: チェックサム (char[4])
          - プロトコルバージョン 209 以降で追加された
          - ペイロードの SHA256(SHA256(ペイロード))の最初の 4 バイトが内部バイト順で格納される
          - ペイロードが空の場合 (verack または getaddr メッセージなど)、チェックサムは常に 0x5df6e0e2 になる
      - 例: verack メッセージ (ペイロードなし) のメインネットメッセージヘッダの 16 進ダンプ
        - f9beb4d9: 開始文字列 (メインネット)
        - 76657261636b000000000000: コマンド名 (verack) とヌルパディング
        - 00000000: ペイロードサイズ (0 バイト)
        - 5df6e0e2: チェックサム (SHA256(SHA256(<空文字列>)))
    - Open SSL のライブラリ関数を用いている
    - 詳しくはhttps://en.bitcoin.it/wiki/Protocol_documentation

- Livelock
  - ブロックができた後、ランダムな時間、各ノードはブロック生成まで待たされる
  - ライブロックとは、多くの重複する共有ロックが互いに干渉し続けるため、排他的ロックの要求が繰り返し拒否される状況
  - 他のノードが作ったブロックを読む時間を作るため
  - 長所
    - Forks がなくなる
  - 短所
    - コンセンサスの時間がかかる

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch12_mining.adoc#L1119
https://en.bitcoin.it/wiki/Protocol_documentation#ping
https://developer.bitcoin.org/reference/p2p_networking.html

## 新しいブロックの検証

- 他のノードはどのように新しいブロックの検証をしているのか？
- 各ノードは受け取った新規ブロックについて、他のノードへ伝搬する前に独立に検証を行う

  - **ブロックのデータ構造が正しいこと**

  - **ブロックハッシュがターゲットより小さいこと**

    - 適切な作業の証明(PoW)が行われているかを確認する

  - **ブロックのタイムスタンプが、ノードが持つ時間より 2 時間未来の時間よりも小さいこと**

    - タイムスタンプの改ざんを防ぐため
    - 逆に 2 時間以内の誤差は許容されうる
    - ブロックの伝播に若干の時間がかかるため

  - **ブロックサイズが受け入れられる制限内(1MB)であること**

  - **最初のトランザクションのみが coinbase トランザクションであること**

  - **ブロックに含まれるすべてのトランザクションが、「独立したトランザクション検証」のチェックリストをすべて満たすこと**

    - 具体的には、
    - トランザクションの構造が正しいこと
    - トランザクションサイズが上限(現在 100KB)以下であること
    - トランザクションロックタイム(nLockTime)が適切であること
    - 空のトランザクションでないこと
    - 重複するトランザクション ID がないこと
    - 入力の総額が出力の総額を超えていないこと
      - トランザクションが新規コインを生成していないことを確認
    - すべての入力の署名が有効であること
      - 各入力トランザクション出力の所有権を正しく検証できる署名となっているか確認
    - すべての入力トランザクション出力が使用可能であること
      - 二重支払い等がなく、入力として参照される出力が未使用であることを確認

- この検証を全ノードが行うことで不正が行われないようになっている
  - もし受け取ったノードがブロック内の情報を書き換えたとしても他のノードでの検証に失敗する
  - もし受け取る一瞬前に自分もマイニングに成功していた場合
    - メインチェーンではなくセカンダリーチェーンにつなげる
    - フォークした時点で更新時間が古いチェーンになると、ノードはそのチェーンを無視する
    - しかし、フォークしたチェーンの長さがメインチェーンを追い越せば、それがメインチェーンとみなされる(PoW)

出典・参考
https://en.bitcoin.it/wiki/Block_timestamp

## ブロックのチェーンの組み立てと選択

- ブロックの検証後、チェーンへの追記が試行される．

  - 無効なブロックは破棄される

- 各ノードは 3 つのブロックセットを持つ

  - メインチェーン

    - 最大長を持つ

  - セカンダリチェーン

  - メインチェーンから分岐した兄弟チェーンも、将来的にメインチェーンに置き換わる可能性があるため保持される

  - オーファンブロックプール

    - 親が不明なブロック

- Previous Block Hash を見てどのチェーンに属するものか判断する

  - 多くの場合はメインチェーンの最新ブロックに

- セカンダリチェーンを伸ばすブロックを受け取り、結果としてメインチェーンが置き換わることも
  ある

  - 最長チェーンが入れ替わる

- 親が見つからないが検証を通るブロックを受け取ると、親チェーンの情報を受け取るまでの間、オーファンブロックプールへ保存される

- オーファンブロックはブロック受け取り順序が逆になった際によく生じる

  - 親が不明だが検証は通るブロックが、オーファンブロックプールに保存される

  - 親チェーンの情報が届くまで保持される

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch10_network.adoc#L1227

## ブロックチェーンフォーク

- フォークには三種類ある

  - 一時的なフォーク

    - 後ほど説明する

  - ソフトフォーク

    - １本のチェーンを維持したまま、ブロック生成に関する仕様変更が行われた場合に発生する。仕様変更が行われるタイミングにずれが生じると、マイナーによっては変更前の旧仕様のまま新ブロックを生成してしまう可能性があり、一方で同様に変更が間に合っていないマイナーは旧仕様の新ブロック生成を受け入れてしまう。

  - ハードフォーク
    - １つの仮想通貨の仕様が議論される中で、複数の方式が提案、検討された結果、コミュニティ内で合意が取れず、両方の仕様のチェーンが併存する時に起こる。
      - e.g. ビットコインでは 2017 年にビットコインキャッシュ(BCH)とのハードフォークが発生した

- 一時的なフォーク（以降フォークで表記）：

  - 伝達ラグによってフォークがおこる．世界中に存在するノードで同時に伝搬を完了させるのは不可能．

- フォークの具体的なプロセス

  - 異なるマイナーが同時期にブロックを見つける
  - それぞれのマイナーがブロックをネットワークに流す
  - 一部のノードは特定のブロックを受信し、別のノードは別のブロックを受信する
  - 結果として、ネットワーク上に複数の有効なブロックチェーンが一時的に共存する状態(フォーク)が発生

- フォークへの対処

  - ノードは複数のチェーンを一時的に保持する
    - メインチェーン(最長の有効チェーン)
    - セカンダリチェーン(フォークされたチェーン)
  - 次のブロックが見つかると、作業証明の総量が大きいチェーンが選ばれメインチェーンとなる
  - 作業証明が小さいチェーンは無効化され、破棄される

- フォークの長期化への対策

  - コンセンサスルールの変更が発生した場合、複数の互換性のないブロックチェーンが長期に渡って並存する
  - 異なるルールを採用する深刻なフォークが発生すると、ネットワークの分裂が生じる可能性がある
  - そのような事態を避けるため、重要な変更は事前に合意形成が行われる

- 伝達ラグによってフォークがおこる．世界中に存在するノードで同時に伝搬を完了させるのは不可能．

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch12_mining.adoc#L1736
https://www.oanda.jp/lab-education/cryptocurrency_basic/cryptocurrency15/blockchain_fork/

## マイニングとハッシュ化競争

- CPU → GPU/FPGA (2011 年) → ASIC (2013 年) と特化ハードウェアへ移行してきた．

  - CPU： 普通のパソコンに搭載

  - GPU： GPGPU で高速な並列計算が可能

  - FPGA: 回路をプログラム可能

  - ASIC：専用回路

- ハッシュレート

  - ビットコインネットワーク全体の毎秒総生成ハッシュ数

- ハードウェアの進化とマイニングノードの増加により、指数関数的に増加している

- これに伴い difficulty も増加するので、新規参入は困難
  - 手元の PC で気軽にマイニングしても難しい

出典・参考
https://d-central.tech/asic-vs-fpga-vs-gpu-vs-cpu-understanding-the-differences/

## マイニングプール

- 複数人でマイニングを分担する仕組み
- 複数人のマイナーを集めて一緒にマイニングを行い、報酬を分配する
- マイナーは報酬額は減るが、日々平均的な報酬を得られるようになる

- 収益の配分方式の代表的な二つ

  - 「PPLNS（Pay Per Last N Share）」
    - マイナーが最近提出したシェア（証明作業の単位）に基づいて報酬を分配する方式。
    - 長期的な貢献を重視
      - マイナーが報酬発生時点から過去の一定期間（N シェア）にわたってプールに貢献した作業量に基づいて報酬を分配するため、短期間の参加よりも長期間の安定した貢献を奨励する。
    - プールホッピングの防止:
      - マイナーが報酬の支払いが予想されるタイミングでのみプールに参加し、報酬を得た後にすぐに離脱する行為。
      - 長期的な参加に基づき貢献度を算出するため、プールホッピングを防止できる
    - プールがブロックを発見するまで報酬が確定しないため、報酬の受け取りに遅延が生じる可能性がある
  - 「PPS（Pay Per Share）」
    - プール全体がマイニングに成功しない場合でも報酬をシェアに応じて受け取ることができるため、収入は安定する。一方で手数料が高くなる傾向がある。

- 初めてのマイニングプールサービスは、「SlushPool」

- 「Stratum protocol」というプロトコルがプール参加者へのやりとりの方法やルールとして運用されている

  - 現在、ほぼ全てのマイニングプールはこのプロトコルに従って動いている。

- マネージドプール

  - 管理者がいるマイニングプール
  - 管理者がプールマイニングプロトコルの管理や、フルノードのメンテナンスなどを行う．
  - 報酬は管理者が受け取って，参加者に分配する
  - 管理者は、報酬の一部を手数料として受けとる

- P2PPool

  - マネージドプールは管理者によって不正がなされる可能性もある

  - P2PPool ではシェアチェーンと呼ばれる小型ブロックチェーンのようなチェーンを用いて
    参加者はシェアチェーンを掘る - ビットコインブロックチェーンより低い Difficulty が設定される

  - そのうち、ビットコインブロックチェーンでの Difficulty を充足させるブロックが発見されると、それを採用する

  - 報酬の分配ルールもシェアチェーンで管理され特定の誰かが不正できなくなっている

- クラウドマイニング

  - 既にマイニング用の設備を持っている事業者に費用を支払い、その分の利益配当を受け取ることができる仕組み。投資信託のようなもの。

  - 自らの購入した分のハッシュパワーに応じた利益を得る

  - 少額から、マシンなしですぐに始められる。

  - 居住地にとらわれず参加可能
    - クラウドマイニングを含むプールマイニングでは、電気代が高い地域に住んでいても、電気代の安い地域にあるデータセンターを利用してマイニングに参加できる

出典・参考
https://crypto.watch.impress.co.jp/docs/serial/dmmcourse/1136456.html
https://magazine.ginco.io/post/mining_basicknowledge_02/
https://bitcoin.dmm.com/column/006#:~:text=PPLNS%EF%BC%88Pay%20Per%20Last%20Shares,%E3%81%AE%E3%82%92%E9%81%BF%E3%81%91%E3%82%8B%E3%81%9F%E3%82%81%E3%81%A7%E3%81%99%E3%80%82

## コンセンサス攻撃

- コンセンサス攻撃とは、ビットコインなどのブロックチェーンネットワークにおいて、マイナー（またはマイニングプール）が自身のハッシュパワーを不正または破壊的な目的で使用し、ネットワークのセキュリティや利用可能性を妨害する行為全般を指す。

- 51%攻撃(別名：ハッシュレート攻撃、マジョリティーアタック)

  - 二重支払い攻撃
  - サービス拒否（DoS）攻撃

- 一時的ブロック隠匿攻撃

- 特定のマイナーがハッシュレート（マイナーのコンピューターが 1 秒間に行うことができるハッシュ関数の計算回数）の多くを占めていると、先端のブロック伸長をある程度操作す ることが可能になる

  - 2 ブロック分マイニングできるくらいのハッシュレートを持っていれば、1 ブロック分のフォー クは無効化できる
  - しかし、確認されたトランザクションは時間が経つにつれて不変性を増す。理論上は任意の深さでフォークが可能だが、非常に深いフォークを強制するために必要な計算能力は莫大で、古いブロックを変更することは非常に困難

- 51%アタック(マジョリティーアタック)と呼ばれる

  - 6 ブロック以上を無効化できる可能性がある
  - 特定アドレスが関与する支払いを無効化するために意図的にフォーク
  - 51%というのは必ずしもハッシュレートの 51%が必要というわけではない

- 二重支払い攻撃: 攻撃者が自身のトランザクションを二重に支払うことで、一度は支払ったと見せかけつつ、実際には支払いを無効にし、商品やサービスを無料で手に入れることができる。これは 51%攻撃の一形態として行われることがある

- サービス拒否（DoS）攻撃: マイニングパワーの過半数を持つ攻撃者が、特定のビットコインアドレスへのトランザクションをブロックチェーンに含めないようにすることで、そのアドレスのトランザクションを事実上無効化する攻撃。これにより、特定のアドレスがビットコインネットワーク内で取引を行うことができなくなる

- 一時的ブロック隠匿攻撃 :

  - 攻撃者は、攻撃の起点となるブロックからブロック生成を行うが、通常は生成された nonce やハッシュ値をネットワークに公開（ブロードキャスト）する必要があるが、ブロードキャストを行わない場合でもブロックは生成できるため、見かけ上は唯一つのチェーンのままであるが、ある時点から攻撃者によって隠匿されたブロックが発生し、ネットワーク上からは見えない分岐が発生する。攻撃者が十分な計算能力を持っている場合、十分なチェーンを生成した上で隠匿したチェーンを公開することで、チェーン長が最長となり、既存のパブリックチェーンを無効化できる。
  - 攻撃者は既存のブロックに用いられたハッシュ値に対して、改ざん等の攻撃を試みることなく、またブロック生成の規則に反することなく、既存の同意形成を覆すことができる点が脅威。
  - 実際、Monacoin がこれにより被害を受けた。
    - Monacoin は、2014 年にビットコインから派生した Litecoin をベースにしたブロックチェーンによる仮想通貨で、ブロック生成に係る制限時間は 90 秒とされている。
    - ブロックチェーンの性質として分岐が発生するため、ブロックの確定には後続する一定数のブロックが必要となる。この取引起案から完了までに必要なブロック生成数を承認数と呼び、Monacoin では 18~24 ブロックと定められていた。
    - 攻撃者は、
    - 1. 事前にブロック生成した事実をブロードキャストせずにチェーン生成を行ってチェーンを伸ばし、
    - 2. Monacoin の取引所に対して、攻撃者の保有する Monacoin を別の仮想通貨に換金する取引を確定させた後、
    - 3. セルフィッシュマイニングを実行して隠匿したチェーンで確定した自身の取引を含むチェーンを無効化した。
    - この結果、取引所は攻撃者に対して換金先の通貨を支払うだけでなく、攻撃によって無効化された Monacoin の利用も払い戻すこととなり、二重支払いが発生することになった。

- 当時の Monacoin のように、小さいチェーンであるほど脆弱性が高い。その理由としては、以下の二つが挙げられる。

  - 攻撃が成立するための計算能力の確保は、サービス規模が十分でないほど容易に確保できること。
  - ブロックチェーンの分岐の性質上、取引の確定は確率的であること（確率的ファイナリティ）がある。

- 実際、Monacoin への攻撃の発生後、仮想通貨取引所は一時的に必要な承認数を引き上げ、後者の問題に対する対応を行った。

- マイニングプールが不正を行おうとするとかなり問題である

- コンセンサス攻撃をするには必ずしも 51%以上でなくても良い
  - 51%未満であっても、シェアの占有率が多ければ確率的に書き換えが可能になっていく
  - 詳しくはこちら：https://qiita.com/stnk20/items/297dafff76fd330d8f90
  - 一時的ブロック隠匿攻撃

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch12_mining.adoc#L1580
田中覚. "ブロックチェーンの安全性と運用にまつわる諸問題." 2020

## まとめ

- 新しいブロック（トランザクション）が正しいといかにしてコンセンサスを得るか

  - 皆が同じルールに基づいて検証を行っている
  - もしこの検証を通らないブロックを伝搬させようとしても他の多くのノードで無効と判断され
    る
  - 最長ブロックチェーンが残っていくため、いち早く正しく長いチェーンを作ることがマイナーのインセンティブになっている

- マイニング

  - PoW の解を見つければ報酬を得られる
    -2024/03 現在 6.25BTC=約 6,250 万円（1BTC=1000 万円）

  - マイニング報酬を得たいがためにすべてのノードは「正しい」振舞いをする
    - 正しくブロックを作る
    - 正しくブロックを検証する

- コンセンサスアタック
  - ハッシュレートの多くの割合を一部の人が持ってしまうとコンセンサスメカニズムを破壊できる（51%攻撃）
  - マイニングプールがそれができる傾向があるが、P2PPool など管理者不在の方法も考案されている
