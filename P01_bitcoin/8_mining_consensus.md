# マイニングとコンセンサス

## 概要

- ブロックチェーンは改ざんできないことはわかったが、新しいブロックに含まれる情報がなぜ正しいものがはいるのか、その正しさはどのように全体でコンセンサスを得るのかをここで説明する

- 合意のプロセス

  - [分散化コンセンサス](#分散化コンセンサス)

- トランザクション検証
  - [独立したトランザクション検証](#独立したトランザクション検証)
  - [マイニングノード](#マイニングノード)
  - [ブロックへのトランザクション集積](#ブロックへのトランザクション集積)
  - [トランザクション手数料](#トランザクション手数料)
  - [Coinbase トランザクション概要](Coinbaseトランザクション概要)
- マイニング
  - [マイニング報酬と手数料](#マイニング報酬と手数料)
  - [Coinbase トランザクションの構造](#coinbaseトランザクションの構造)
  - [ブロックヘッダの構築](#ブロックヘッダの構築)
  - [ブロックのマイニングー Proof-of-Work アルゴリズム](#ブロックのマイニングーproof-of-workアルゴリズム)
  - [マイニングのプログラム例](#マイニングのプログラム例)
  - [difficulty ターゲットの表現](#difficultyターゲットの表現)
  - [difficulty ターゲットの更新](#difficultyターゲットの更新)
  - [マイニングに成功したら](#マイニングに成功したら)
- ブロック検証
  - [新しいブロックの検証](#新しいブロックの検証)
  - [ブロックのチェーンの組み立てと選択](#ブロックのチェーンの組み立てと選択)
  - [ブロックチェーンフォーク](#ブロックチェーンフォーク)
  - [マイニングとハッシュ化競争](#マイニングとハッシュ化競争)
  - [マイニングプール](#マイニングプール)
  - [コンセンサス攻撃](#コンセンサス攻撃)

## 分散型コンセンサスの基礎

分散型コンセンサスは、中央管理者が存在しない状況で、ネットワーク上の全参加者が共通の合意に達するためのプロセスである。このプロセスは、ブロックチェーン技術の核心部分を形成し、ビットコインを含む多くの仮想通貨の基盤となっている。


- コンセンサスアルゴリズムの種類
分散型コンセンサスを実現するためには、様々なコンセンサスアルゴリズムが存在する。主なものには以下がある。

- Paxos：分散システムにおける合意形成のためのアルゴリズムの理論を築いたモデル。
- Raft：Paxosよりも理解しやすいことを目指した合意形成アルゴリズム。
- PBFT（Practical Byzantine Fault Tolerance）：ビザンチン障害に耐えることができるアルゴリズム。
- PoW（Proof of Work）：計算問題を解くことで合意形成を行うアルゴリズム。ビットコイン等で使用されている。
- PoS（Proof of Stake）：保有している通貨の量に基づいて合意形成を行うアルゴリズム。Ethereum等で使用されている。


- 中央管理者なしでの真実と合意の形成

分散型コンセンサスでは、中央管理者がいないため、ネットワーク上の各参加者が独立して動作し、全体として最適に動くことが求められる。このプロセスは以下の4つの相互作用で成り立つ。

1.  独立したトランザクション検証
    ビットコインネットワークでは、すべてのフルノードがトランザクションを検証する。この検証プロセスは、ネットワーク上で共有されている包括的なトランザクションリストに基づいて行われる。各ノードは、このリストに従ってトランザクションが正しいかどうかを独立して判断し、その結果を他のノードと共有する。このプロセスにより、ネットワーク全体でトランザクションの正当性が確認される。

2.  独立したトランザクション集積
    トランザクションが検証された後、マイニングノードはこれらのトランザクションをブロックに集積する。このプロセスはProof of Work（PoW）アルゴリズムによって支えられており、マイニングノードは計算問題を解くことで新しいブロックを生成する権利を得る。マイニングノードは、自らが解いた計算問題に基づいて、トランザクションをブロックに追加することができる。

3.  独立した新規ブロック検証とブロックチェーンへの埋め込み
    新しいブロックがマイニングノードによって提案されると、ネットワーク上のすべてのノードはそのブロックを検証する。この検証に成功すると、各ノードは新しいブロックを自身が保持するブロックチェーンに追加する。これにより、ネットワーク全体でのデータの一貫性が保たれる。

4.  独立したブロックチェーン選択
    ビットコインネットワークでは、複数のブロックチェーンが同時に存在することがある。この場合、各ノードはPoWを通じて証明された、最も多くの累積計算量を持つブロックチェーンを選択する。これにより、最も長いブロックチェーンが正当なものとして認識され、ネットワーク全体での合意が形成される。

- なぜコンセンサスの創発と呼ばれるのか
  Bitcoin のコンセンサスの流れ：マイナーが主張している内容を、各ノードが検証し、ノード全体の合意という形でその内容は認証される
  このコンセンサスは、全参加者により常に行われている検証によって創り出されている。このような方法によるコンセンサスは、創発的（emergent）コンセンサスと呼ばれる。
  このコンセンサスの方式が、情報の信頼性を保証する別の仕組み、PKI(公開鍵基盤)と最も違う点である。
  PKI は、信頼できる第三者を利用して「事実の主張」を確認する手段である。PKI では，主体が主張している内容を認証局などが確認のうえで事実として承認し、電子署名によって認証していた。

## 独立したトランザクション検証

- ビットコインネットワークでは、各ノードがトランザクションを独立して検証する。この検証プロセスは、不正なトランザクションがネットワークに広がるのを防ぐ。主な検証ポイントは以下の通り。

1. 二重支払いの防止
各トランザクションのインプットが過去に支払われていないことを確認する。これにより、一度使われたビットコインが再度使用されることを防ぐ。

2. 新たなビットコインの生成防止
トランザクションのインプットの合計額がアウトプットの合計額以上であることを確認する。これにより、許可されていない新たなビットコインの生成を防ぐ。

3. 署名の検証
トランザクションに含まれる署名が有効であることを確認する。これにより、トランザクションの正当性を保証する。

- トランザクションがネットワークに送信されると、以下の手順で検証される。

- インプットの存在と使用状況の確認
  ノードは、各インプットが未使用のトランザクション出力（UTXO）であることを確認する。

1. 二重支払い防止のため、ノードは各インプットが存在すること及び過去に使われてないことを確認する(UTXO セットにアクセスし、UTXO を追跡することであるインプットが二重支払いかどうか検証可能)
2. UTXO は Unspent Transaction Outputs の略。インプットに未だに払われていないものが入っていなければ、二重支払いであるということが判明する。

- インプットの合計額とアウトプットの合計額の確認
 インプットの合計額がアウトプットの合計額を上回っているかを検証する。

1. ノードはインプットの合計がアウトプットの合計以上であることも確認する(これによりトランザクションが新たなコインを作成することを防ぐ)(後述する coinbase トランザクションは例外)

- 署名の確認
  トランザクションの各インプットに対して、適切な署名が存在するかを確認する。

1. トランザクションは通常は 1 インプットにつき少なくとも 1 つ以上の署名を持つ。ここで署名ハッシュを取得する部分において、署名は ScriptSig の一部であるためにトランザクションのシリアライズをハッシュすることができない(署名は ScriptSig の一部であり、署名自体に署名できないから)
2. 代わりに、インプットごとに異なる署名ハッシュを計算する(署名前にトランザクションを変更する)
3. 全ての ScriptSig を空にする
4. 署名されるインプットの ScriptSig を前の ScriptPubKey に置き換える
5. ハッシュタイプを付加する(4 バイトのハッシュタイプを末尾に加えることで署名が正当性を認める内容を指定する)

- このような手順を踏むことでトランザクション検証プロセスが行われる。署名ハッシュのアルゴリズム自体は非効率的で無駄が多いため、Segwit 以降は所謂二次ハッシュ問題は別手法により解決されている

その他の補足説明

- インプットのいずれも hash=0, N=-1 でないか(coinbase トランザクションでないか)
  - coinbase トランザクションは新しく生成されたビットコインと、ブロックを採掘することによって得られるトランザクション手数料を採掘者（マイナー）に報酬として与える特別なトランザクション。
  - トランザクション ID（TxID）が全て 0 で、過去のトランザクションを参照しないことを意味し、出力インデックス（vout）が-1 となる。
- nLockTime は INT_MAX 以下か
  - nLockTime は、トランザクションを遅延させる時間やブロックの高さを示している。トランザクションが意図した時間やブロック高さまで正しく遅延されるように確認している。
  - LockTime は発行されたトランザクションがチェーン上に保存される前に、それを他のノードが確認することを可能にする。LockTime を長くすると、そのトランザクションがよく伝播した上でチェーンに追加されるので、フォークが減る一方、コンセンサスの時間がかかる事になる。
- オーファントランザクションとは
  - オーファントランザクション（Orphan Transaction）は、ビットコインネットワークにおいて、その入力となるトランザクション（親トランザクション）がまだネットワークに認識されていない、あるいは利用可能なブロックチェーンの履歴に含まれていないトランザクションを指す
  - オーファントランザクションは、ビットコインネットワーク上でトランザクションが非順序で伝播するときに発生することがある。
  - 近年では、ビットコインのプロトコルや実装の改善により、オーファントランザクションが発生する頻度は減少している。
- なぜトランザクション手数料が少なすぎるといけないのか
  - スパム攻撃の防止
    - ネットワークを圧迫し、正当なトランザクションの処理を遅くすることができる
  - 手数料はマイナーにとっての貴重な収入源
    - ネットワークを維持するインセンティブになるので、低すぎない手数料でないと却下する。
- 各インプットのアンロッキングスクリプトは，対応したアウトプットのロッキングスクリプトを解除できるか．
  - ロッキングスクリプトは、トランザクションのアウトプットに配置され、その資金が使用される条件を定義する
  - アンロッキングスクリプトは、トランザクションのインプットに含まれ、対応するアウトプットのロッキングスクリプトに設定された条件を満たすために使用される tt
- COINBASE_MATURITY(100)

  - COINBASE_MATURITY とは、coinbase トランザクションによって生成されたビットコイン）が使えるようになるまでの承認の数である
  - ビットコインの場合、その値は 100 であり、ビットコインが採掘されてから、そのビットコインを使って他のトランザクションを行うことができるようになるまで、約 100 ブロック分（約 16 時間 40 分から 17 時間）の時間が必要。
  - 二重支払いを防ぐ
    - 採掘者が一時的に生成したブロックを使ってトランザクションを実行し、その後にそのブロックがオーファン（孤立）ブロックとなった場合、ビットコインは事実上二重で使われることになってしまう。
  - ネットワークの安定性確保
    - チェーンに保存されることが確定するまで時間をおくことができる。
  - ビットコインの価格が急激に変動するのを防ぐ。

- その他のコンセンサス
  - PBFT - コンソーシアム型むきのコンセンサスアルゴリズム。ノードが小規模かつ、固定されている時向け。リーダーが Validating peer に対して Tx を正しく送ったことを信頼している - 長所 - Tx を実行する権限が、プライマリーノードしかないため、トランザクションに分岐が発生せず、履歴が覆ることがない - 短所 - 基本的に、ノードを信頼しないといけない - 一つの機械、ノードが一つの vote なので、一定数を超えた悪意があるものがいれば、コンセンサスは止まる - スケーラビリティ：PBFT の効率は、ネットワーク内のノードの数に強く依存します。ノード数が増加すると、必要なメッセージの数が指数関数的に増加し、ネットワークの遅延と帯域幅の使用が大幅に増加します。これは、大規模なネットワークでの使用を困難にします。 - vertual machine software にアクセスした 1 人が（承認されれば）ノードをいくらでも増やせるようになっていた

## マイニングノード

- マイニングノードの役割
  マイニングノード、またはマイナーと呼ばれるこれらのノードは、Proof of Work（PoW）という計算問題を解くことによって新しいブロックを発見する。このプロセスは「マイニング」と呼ばれ、以下のように進行する。

1. ブロックの発見: マイナーはPoW問題を解くことにより、新しいブロックを発見する。この問題を最初に解くことができたマイナーは、新しいブロックをブロックチェーンに追加する権利を得る。
2. 報酬の獲得: ブロックをブロックチェーンに追加すると、マイナーは新たに生成されたビットコイン（ブロック報酬）と、そのブロックに含まれる全てのトランザクション手数料を報酬として受け取る。
3. ブロックの検証: 他のノードは新しく追加されたブロックを検証し、その結果に基づいてブロックチェーンに組み込むかどうかを決定する。検証に失敗したブロックはチェーンに取り込まれない。


- マイニングノードは、必ずしもフルノードでなくともよい。
  - マイニングプールではフルノードなしにマイニングする
  - 一般的には、フルノードとなりすべてブロックの検証が可能な状態のブロックチェーンに対してマイニングする

- 一時的分岐の発生と解決
  ブロックチェーンにおいては、複数のマイナーがほぼ同時に新しいブロックを見つけた場合、一時的にブロックチェーンが分岐することがある。この現象を「一時的分岐」と呼ぶ。分岐したチェーンのうち、最終的に最長のチェーンが正当なものとして採用され、他のチェーンは放棄される。この選択プロセスは以下のように進行する。
  マイナーは受け取った最初の有効なブロックを基にマイニングを続ける。
  新たなブロックが追加されることで、一方のチェーンが他方よりも長くなる。
  ネットワークの他のノードも最長のチェーンを正と認識し、短いチェーンのブロックは無視される。
  このメカニズムにより、ブロックチェーンは一貫性を保ち、ネットワーク全体での合意が形成される。マイニングはブロックチェーンのセキュリティと透明性を保つために不可欠であり、ビットコインシステムの根幹をなす要素である。

##ブロックへトランザクションを集積するプロセス
- トランザクションはブロックに追加されることでデータとして保持される。そのプロセスとして、ネットワークのセキュリティを維持する必要がある。

- マイニングノードは候補ブロックを作る
  - 次の新しいブロックとしてトランザクションのリストを持ったブロックを作成する。
  - ブロックのヘッダには、前のブロックのハッシュ、タイムスタンプ、ナンス値、難易度ターゲットなどの情報が含まれる。
    - ハッシュ：入力データを固定長の文字列に変換する暗号技術。
    - タイムスタンプ：ブロックが生成された時間。
    - ナンス値：マイニングプロセスで使用される一時的な値。
    - 難易度ターゲット：ブロックが有効とされるためにハッシュが満たすべき条件。

- トランザクションは自身のトランザクションプールから選ぶ
  - ここにはそのノードが受け取ったがまだブロックチェーンに取り込まれていないトランザクションが格納される。他のノードのトランザクションプールとは異なることがある。
    - トランザクションプール：未承認のトランザクションが一時的に保管される場所。

- 候補ブロックのナンス値を見つける（PoW）
  - PoW（Proof of Work）：特定の計算問題を解くことでブロックを生成する方法。
  - これはマイニングの難易度（難易度ターゲット）によって変化する。
  - ナンス値はマイナーが PoW を探す際に変更される。

- 候補ブロックに入れるトランザクションは優先度が決められる
  - その基準には、手数料、CoinAgePriority(今は使われていない)などが用いられる。
    - 手数料：トランザクションを優先的に処理するために支払われる追加の費用。
    - CoinAgePriority：過去に使用されていたトランザクションの優先順位決定基準。

- ブロックサイズとトランザクション容量
  - ブロックのサイズには上限がある。現在は 1MB の基本ブロックサイズに加えて、SegWit による拡張部分があり、倍程度になっている。
    - SegWit（Segregated Witness）：トランザクションの署名データを分離することでブロックサイズを効果的に拡張する技術。

以上がトランザクションをブロックへ集積するプロセスである。このプロセスは、ネットワークの安全性と効率性を確保するために非常に重要である。

出典・参考
https://tottemoyasashiibitcoin.net/entry/2016/12/01/215608
https://xtech.nikkei.com/atcl/nxt/column/18/02132/082900006/#:~:text=Bitcoin%E3%81%AE%E5%A0%B4%E5%90%88%E3%81%AF1,%E5%BD%93%E3%81%9F%E3%82%8A7%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E3%81%AA%E3%82%8B%E3%80%82
https://gaiax-blockchain.com/segwit#:~:text=Segwit%E3%81%AB%E3%82%88%E3%81%A3%E3%81%A6%E4%BB%A5%E4%B8%8B%E3%81%AE%E5%BC%8F,%E5%BC%8F%E3%81%8C%E5%B0%8E%E5%85%A5%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82&text=%E5%BE%93%E6%9D%A5%E3%81%AE%E3%82%88%E3%81%86%E3%81%AB%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF,%E6%A0%BC%E7%B4%8D%E3%81%A7%E3%81%8D%E3%82%8B%E3%81%93%E3%81%A8%E3%81%AB%E3%81%AA%E3%82%8A%E3%81%BE%E3%81%99%E3%80%82

## トランザクション手数料

トランザクション優先度
トランザクションの優先度は以下の要素から計算される：

- トランザクションサイズ：トランザクションのデータサイズ。
- 手数料：トランザクションに添付される手数料の額。
- Age（エイジ）：トランザクションに含まれるビットコインが最後に移動された時間。

これらを基にノードはトランザクションを受け取る手数料を多くすることで、自分のブロックに入れるトランザクションを選定する。ブロックサイズが1MBという制限があるため、そのサイズ内にできるだけ多くのトランザクションを収める必要がある。また、古いUTXO（未使用トランザクション出力）を優先して使用することがある。

- 最初の 50KB
  - ブロック内の最初の50KBには、優先度に基づいたトランザクションが含まれる。この優先度は以下の式で計算される：
  - Priority = Sum (Value of Input \* Input Age) / Transaction Size
    - ここで
    - Value of Input ・・・ Input を単位 satoshi で．（1BTC=1 億 satoshi）で表したもの。
    - Input Age ・・・ Input の UTXO が含まれるブロックから現在のブロック高の差。

- 残り
  - ブロックの残りの部分には、トランザクション手数料をデータサイズで割った順にトランザクションが含まれる。

※ 上記は過去、トランザクションが少なかった頃採用されていたルールの様子。現在はすべてトランザクション手数料を見て判断されている

- トランザクション手数料の意義
  - トランザクション手数料には以下の意義がある：
  - そもそもマイナーにはブロックを小さく保とうとする明確な動機が存在する(ブロックにトランザクションを追加すればするほど、ブロックを伝播する時間が長くなり、他のマイナーによって次のブロックが先に見つかるリスクが増え、ブロック間のマイニング競争で不利になる)
  - しかしながら、ブロックにトランザクションを追加するたびにマイナーが得る収入が増えるとすると、マイナーの競争力の低下を補うインセンティブが発生する
  - これはあくまでひとつの説明だが、実際に効力をなしている

- Bitcoin のトランザクション手数料の計算方法
  ビットコインのトランザクション手数料は、トランザクションサイズ（バイト）によって決定される。送金する額ではなく、データサイズが基準となる。

  - このレート（e.g. 80 satoshi/バイト）は送金需要を反映して変動する。
  - 手数料が高すぎると、ビットコインは日常的な決済に適さなくなる。
  - 手数料を低く抑えたいが、それに伴ってスケーラビリティの問題が発生する。

コンセンサスルール
- ビットコインのコンセンサスルールのひとつに、任意の非 coinbase トランザクションにおいてはインプットの合計 ≧ アウトプットの合計というものがある。トランザクションのコストがゼロであるならば、マイナーがトランザクションをブロックに取り込むインセンティブがなくなるから

  - 手数料はマイナーがトランザクションをブロックに含める動機になる、故に高い手数料は早い処理速度に繋がる。

- このように、インセンティブ設計ひとつ取っても中央管理者抜きでビットコインシステムが成り立つ基盤となっている

優先度の変遷
- 元々は Coin Age Priority というトランザクションの手数料と優先度を定めたロジックが存在したが、今はない。現在では、トランザクションを早く通す(早くブロックに取り込まれる)ためにはいくつかの要因があるが、手数料の支払い額が優先度の大きな判断基準となっている

  - その優先度に従って候補ブロックに入れるトランザクションが決められる。
  - 現在はトランザクションの選択は主に手数料に基づいている。
  - 以前は手数料に加えて、Coin Age Priority（トランザクションに含まれるビットコインが最後に動いた時間）に基づいていた。

長期的な持続可能性
- ブロック報酬が時間とともに半減していく中で、トランザクション手数料はマイナーにとってますます重要な収入源となる。これは、ビットコインネットワークが長期的に持続可能であるための基盤となる。

出典・参考
https://academy.binance.com/ja/articles/what-are-blockchain-transaction-fees

## Coinbase トランザクション概要

- 各ブロックの最初に要求されるトランザクションをcoinbaseトランザクションまたはgenerationトランザクションと呼ぶ。このトランザクションは特別なもので、マイナーが新しいブロックを生成する際に自分自身への報酬を含むトランザクションである。

特徴と構造

- マイナーへの支払い：

  - Coinbaseトランザクションには、ブロック内の他のトランザクションから発生する全ての手数料とブロック報酬が含まれる。
  - ブロック報酬は、マイナーが新しいブロックを発見したことに対する報酬であり、ビットコインネットワークによって新たに発行されるビットコインと、ブロックに含まれる全トランザクションの手数料の合計で構成される。

- インプット

  - インプット部分は「coinbase」と呼ばれる特別なデータ領域であり、通常のトランザクションとは異なり、UTXO（未使用トランザクション出力）を参照しない。
  - マイニング報酬は無から生み出され、対応するUTXOが存在しないため、この特別な領域には任意のデータを含めることができる。しばしば、マイニングプールの情報やその他のメッセージが含まれる。
  - この領域はエクストラナンス（extraNonce）としても使用される。エクストラナンスは、ナンス値（nonce）の範囲（32ビット、2^32通り）を超えて計算を続けるための追加のパラメータである。

- アウトプット

  - アウトプットはマイナーのアドレスに送られる。Coinbaseトランザクションのロッキングスクリプトは、マイナーが報酬を使用できるようにするために、公開鍵を基にしたものとなっている。
  - これにより、Coinbaseトランザクションはマイナーに対してブロック報酬（マイニング報酬）を支払う構造となっている。

- マイニング報酬とブロック報酬の違い

  - マイニング報酬：

    - マイニング活動から得られる全体的な報酬を指す。これには新しいコインの発行（ブロック報酬）と、ブロックに含まれるトランザクションから得られる手数料が含まれる。

  - ブロック報酬：

    - 新しいブロックを発見した際にマイナーに与えられる特定の報酬を指す。これは新規発行のビットコインと、ブロックに含まれる全トランザクションの手数料の合計で構成される。

まとめ

  - Coinbaseトランザクションは、ビットコインのブロックチェーンにおいて非常に重要な役割を果たしている。これはマイナーに対する報酬を提供し、ビットコインネットワークのインセンティブ構造を支えている。マイニング報酬とブロック報酬の区別を理解することで、ビットコインの経済モデルをより深く理解することができる。

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/glossary.asciidoc#L27
https://medium.com/fcats-blockchain-incubator/understanding-the-bitcoin-blockchain-header-a2b0db06b515
https://scrapbox.io/chaintope/ExtraNonce_%E3%81%A8%E3%81%AF%E3%81%AA%E3%81%AB%E3%81%8B
https://github.com/bitcoinbook/bitcoinbook/blob/develop/ch12_mining.adoc

## マイニング報酬と手数料

- マイニング成功時に得られる報酬は、マイニング報酬＋手数料

- マイニング報酬

  - マイニング報酬とはすなわちビットコインの新規発行

  - 210,000 ブロックごとに報酬は半減する

  - 約 4 年、1 ブロック=10 分

  - 最初 50BTC で、2020 年 5 月には 6.25BTC になった

  - 2024/01 現在 1BTC≒600 万円なので約 3,700 万円

  - 最終的にマイニング報酬が 0 になるのは 2140 年ごろ、そのころになると 1satoshi（1BTCの100,000,000分の1）を切る。そのとき総発行量は 2100 万 BTC となる

- マイニング報酬の目的

  - マイナーは計算問題を解くことでトランザクションを検証し、新しいブロックをブロックチェーンに追加する。このプロセスにより、不正行為やダブルスペンディング(同じビットコインを複数回使用しようとする不正行為のこと)を防ぐことが可能になっている

  - マイナーに、マイニングを通して、ビットコインネットワークのセキュリティと整合性を保つよう促すためのもの。

- 半減期に関連する経済用語

  - デフレーション効果

    - 物価の下落が消費者や企業の行動に与える影響のことで、物価が下がることで消費者の購買力が増す一方で、将来的にさらに価格が下がると予想されるため、消費が抑制される可能性もある。

  - 希少価値

    - あるものが希少であることから生じる価値のこと。

  - 供給制限

    - モノやサービスの需要に対し、人手不足や物流の停滞などで供給が追いつかないこと

- 手数料

  - Total Fees = Sum(Inputs) – Sum(Outputs)

    - ブロック内に入れるトランザクション全体の手数料総和

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch12_mining.adoc#L72
https://www.coinex.com/ja/blog/3270-what-is-issuarance-limit
https://plisio.net/ja/blog/what-is-bitcoin-halving

## Coinbase トランザクションの構造

- インプットは必ず一つのみ

- インプットの特徴(条件):
  - トランザクションIDが32バイトの00である。
  - トランザクションインデックスが0xFFFFFFFFである。
  - 任意のデータをアンロッキングスクリプトの代わりに入れられる。
    - e.g. サトシ・ナカモトがジェネシスブロックのコインベーストランザクションに含めた文章
    - The Times 03/Jan/2009 Chancellor on brink of second bailout for banks


- Coinbaseトランザクションのフィールド

  - トランザクションハッシュ（32バイト）:
    - 全ビットがゼロであり、トランザクションハッシュへの参照ではない。
  - アウトプットインデックス（4バイト）:
    - すべてのビットが1で、0xFFFFFFFF。
  - コインベースデータサイズ（1～9バイトのVarInt）:
    - コインベースデータの長さを示す（2から100バイトの間）。
  - コインベースデータ（可変長）:
    - 任意のデータを含む。v2ブロックではブロック高から始まる。
  - シーケンス番号（4バイト）:
    - 0xFFFFFFFF。この特殊なインデックス値により、システムはこのトランザクションが特定のUTXOを参照していないことを認識できる。

- 特殊なデータの使用例
  - ブロック高:
    - トランザクションの最初にブロック高を入れる。
  - エキストラナンス:
    - マイニング時の追加情報やマイニングタグとして使用される。


- 通常のトランザクションインプットとの違い

  - 通常のトランザクションインプットは以下のフィールドで構成される:

  - トランザクションハッシュ（32バイト）:
    - 使用するUTXOを含むトランザクションへのポインター。
  - アウトプットインデックス（4バイト）:
    - 使用されるUTXOのインデックス番号。
  - アンロッキングスクリプトサイズ（1～9バイトのVarInt）:
    - アンロッキングスクリプトの長さ。
  - アンロッキングスクリプト（可変長）:
    - UTXOのロッキングスクリプトの条件を満たすスクリプト。
  - シーケンス番号（4バイト）:
    - 通常0xFFFFFFFF。BIP125とBIP68のオプトアウトを示す。

まとめ
- Coinbaseトランザクションは、新しいビットコインを生成し、マイナーに報酬を与えるために存在する特別なトランザクションであり、そのインプット構造は通常のトランザクションと大きく異なる。特定の条件とフィールドによって識別され、ブロックチェーンのセキュリティと整合性を保つために重要な役割を果たしている。



出典・参考
https://cointelegraph.com/explained/what-is-a-coinbase-transaction
https://learn.saylor.org/mod/book/view.php?id=36375&chapterid=19427#:~:text=In%20a%20coinbase%20transaction%2C%20the,to%200xFF%20(255%20decimal)
https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki
https://github.com/bitcoin/bips/blob/master/bip-0125.mediawiki

## ブロックヘッダの構築

ブロックヘッダとは
- ブロックヘッダは、ブロックに含まれるトランザクションに関するメタデータであり、マイニングに成功した場合にマイナーが構築する必要がある。ブロックヘッダが正しく構築されないと、そのブロックは無効となり、報酬が失われる可能性があるため、慎重に作成する必要がある。

ブロックヘッダの構成
| Size     | Field               | Description                                                          |
| -------- | ------------------- | -------------------------------------------------------------------- |
| 4 bytes  | Version             | A version number to track software/protocol upgrades.                |
| 32 bytes | Previous Block Hash | A reference to the hash of the previous (parent) block in the chain. |
| 32 bytes | Merkle Root         | A hash of the root of the merkle tree of this block’s transaction.   |
| 4 bytes  | Timestamp           | The approximate creation time of the block.                          |
| 4 bytes  | Difficulty Target   | The proof of work algorithm difficulty target for this block.        |
| 4 bytes  | Nonce               | A counter used for the proof of work algorithm.                      |

ブロックヘッダにおける用語
- Target PoW の Difficulty Target
- Difficulty target の計算式 difficulty = difficulty_1_target / current_target の difficulty_1_target には bdiff と pdiff がある
  - 相違点
    - bdiff(block difficulty)
      - ビットコインプロトコルがターゲットを表現するために使用するカスタムの浮動小数点型
      - ブロック生成が平均して 10 分に 1 回となるように調整されている
    - pdiff(pool difficulty)
      - マイニングプール内での相対的な難易度を示す
      - 通常は 0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF
    - 例えば current*target = 0x1b0404cb(0x0404cb * 2\*\*(8\_(0x1b - 3)))のそれぞれの難易度は、
      - bdiff:
        - 0x00000000FFFF0000000000000000000000000000000000000000000000000000 /0x00000000000404CB000000000000000000000000000000000000000000000000 = 16307.420938523983
      - pdiff:
        - 0x00000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF /0x00000000000404CB000000000000000000000000000000000000000000000000 = 16307.669773817162

- Litecoinのldiff
  - ビットコイン以外にも、Litecoinなどの他の暗号通貨においては、ldiffと呼ばれる全体のネットワークのターゲット難易度を示すものも存在する。

- Nonce マイニングで求める値。マイナーが PoW を探す際に変更される


出典・参考
https://learn.saylor.org/mod/book/view.php?id=36375&chapterid=18988
https://en.bitcoin.it/wiki/Difficulty
https://stackoverflow.com/questions/52972514/where-and-how-pool-difficultypdiff-is-set-in-bitcoin-source-code
https://bitcoin.stackexchange.com/questions/24349/in-pooled-mining-what-is-pdiff-bdiff-and-ldiff

## ブロックのマイニングー Proof-of-Work アルゴリズム

マイニングの概要
- マイニングとは、新しいブロックをブロックチェーンに追加するプロセスであり、特定の条件を満たすナンス（Nonce）を見つける作業を指す。この条件とは、ブロックヘッダのハッシュ値がターゲット難易度未満になることである。

マイニングの手順

- トランザクションリストの選択とブロックヘッダの構築:
  - トランザクションリスト:
    - 送信者、受信者、送金額などの情報を含む。
  - ブロックヘッダ:
    - バージョン情報、タイムスタンプ、直前のブロックのハッシュ値、マイニング報酬のアドレスなどを含む。
    - このブロックヘッダは、ブロックを識別するための情報を提供し、改ざんされるとチェーン全体の信頼性が失われる。

- ナンス値（4バイト）の発見:

  - ブロックヘッダに追加されるランダムな値で、マイニングの難易度調整に使用される。
  - 異なるナンス値により、ブロックヘッダのハッシュ値が変化する。

- ブロックハッシュの生成:
  - ブロックヘッダのダブルハッシュ値（SHA-256を2回適用した値）を求める。
  - このハッシュ値の先頭にゼロがいくつか並ぶようにする。ゼロの数はその時点のターゲット難易度によって決まる。

- ナンス値の試行:
  - ハッシュ値がターゲット未満になるようなナンス値を探す。
  - 例:
    - ターゲット: 0x0000000000000003A30C00000000000000000000000000000000000000000000
    - この場合、生成されるブロックハッシュ値がこのターゲットよりも小さい必要がある。

難易度とナンス

- ナンス（4バイト）:
  - 4バイト整数の最大値は約43億（4,294,967,296）。
  - ナンスだけでターゲットを超えるには不十分であるため、膨大な試行が必要。

難易度調整:

- ターゲット難易度が上がると、ブロックハッシュの先頭に必要なゼロの数も増加する。
- 現在のブロックハッシュの例では、先頭19バイトがゼロになっている。
  - 期待値では、2^152回のナンス値の試行が必要（約5.7×10^45回）。
  - これにより、設計当初の想定よりも難易度が非常に高くなっていることがわかる。

まとめ

- マイニングは、トランザクションリストを選択し、ブロックヘッダを構築した後、ナンス値を調整して特定の条件を満たすブロックハッシュを生成するプロセスである。ナンス値の発見と難易度調整は、ブロックチェーンのセキュリティと信頼性を維持するために不可欠であり、その難易度は時間とともに上昇する傾向がある。

出典・参考
https://en.bitcoin.it/wiki/Protocol_documentation#Block_Headers
https://en.bitcoin.it/wiki/Proof_of_work

## マイニングのプログラム例

マイニングの基本

- マイニングとは、ナンス（Nonce）と呼ばれる値を変えてブロックヘッダをハッシュ化し、そのハッシュ値がターゲット難易度以下になるかを繰り返し確認するプロセスである。ハッシュ関数は不可逆で、元の値を少しでも変えるとハッシュ値は大幅に変わるため、ナンスを1つずつ変えながら試行を続ける以外に方法はない。

Python の実装例：

- 以下のPythonコードは、Proof of Work（PoW）アルゴリズムを実装したもので、ナンス値を変えながらターゲット難易度を満たすハッシュを見つける過程を示している。

```python
def proof_of_work(difficulty):
    # nonceは4byte
    for nonce in range(2 ** (4 * 8)):
        header = get_header(nonce)
        blockhash = double_hash(header)
        if blockhash < difficulty:
            return nonce
    raise NotFoundException()
```

PoW のターゲット

- C++コードの例として、PoWのターゲット難易度をチェックする関数が示されている。以下にその関数を簡単に説明する。

  - bool CheckProofOfWork(uint256 hash, unsigned int nBits, const Consensus::Params& params)
    {
    bool fNegative;
    bool fOverflow;
    arith_uint256 bnTarget;
    bnTarget.SetCompact(nBits, &fNegative, &fOverflow);
    // Check range
    if (fNegative || bnTarget == 0 || fOverflow || bnTarget > UintToArith256(params.powLimit))
    return false;
    // Check proof of work matches claimed amount
    if (UintToArith256(hash) > bnTarget)
    return false;
    return true;
    }

- 4 バイトのナンス値（nonce）を 0 から 2^32-1 までループ
- ナンス値とその他のヘッダ情報からブロックヘッダを生成
- ブロックヘッダをハッシュ関数に２回通してブロックハッシュを計算
- ブロックハッシュとターゲット値を比較
- ブロックハッシュがターゲット値より小さい場合、ナンス値を返す
- ターゲット値より大きい場合は、ループを継続
- 2^32 回のループ後もターゲット値以下にならなかった場合、NotFoundException を発生させる

まとめ

- このマイニングプロセスは、ナンス値を調整しながらターゲット難易度を満たすハッシュを見つける試行錯誤の連続である。Pythonの例では基本的な実装方法を示し、C++コードの例ではターゲット難易度の計算と確認方法を示した。これらの知識を組み合わせることで、実際のマイニングアルゴリズムの理解が深まるだろう。

出典・参考
https://github.com/bitcoin/bitcoin/blob/98005b6a17907c4f7bdcf802ee96c274492f902a/src/pow.cpp#L125

## difficulty ターゲットの表現

Difficultyチェックの重要性

- マイニングの活性度確認: マイニングの活性度や競争の激しさを確認するためにDifficulty（難易度）をチェックする。
- 報酬の目安: 現在のマイニング報酬が割安か割高かの目安を提供する。

Difficultyターゲットの構造

- Difficultyターゲットはブロックヘッダに含まれており、4バイトで表現される。具体的には、次のように構成される。

  - 4バイト（32ビット）
    - 最初の1バイト: 指数（exponent）
    - 残りの3バイト: 係数（coefficient）
  - 小さいほど難易度が高く、大きいほど難易度が低い

ターゲットの計算式

- ターゲットは次の式で表される：
- target = coefficient _ 2 ^ (8_(exponent-3)) で表される

- 計算例: 0x1903a30c なら

  - target = 0x03a30c _ 20x08_(0x19-0x03)

  - target = 0x03a30c * 2(0x08*0x16)

  - target = 238,348 * 28*22

  - target = 238,348 \* 2176

  - target = 22,829,202,948,393,929,850,749,706,076,701,368,331,072,452,018,388,575,715,328

  - target = 0x0000000000000003A30C00000000000000000000000000000000000000000000

まとめ

- Difficultyターゲットの計算は、指数と係数を用いてターゲットを求める。ターゲットが小さいほどマイニングの難易度が高く、ターゲットが大きいほど難易度が低い。これにより、ネットワーク全体のマイニングの難易度を調整し、一定のペースでブロックが生成されるようにする。

出典・参考
https://en.bitcoin.it/wiki/Difficulty
https://coinpost.jp/?p=263918

## difficulty ターゲットの更新

更新の目的

- ブロック生成時間が10分間隔で保たれるように、Difficultyターゲットは定期的に調整される。この調整は、次のような理由から重要である：

  - コンピュータの急激な進化に対応するため。
  - マイニング参加者やコンピュータ台数の変動に対応するため。
  - 短すぎる生成間隔はオーファンレート（孤立ブロックの発生率）を増加させ、長すぎる生成間隔はトランザクションの確定待ち時間を不便にする。

調整の頻度

- ターゲットは、ブロックが10分間隔で生成されるように、**2週間ごと（2016ブロックごと）**に調整される。

調整の計算式

- 新しいターゲットは以下の式で計算される：

> New Target = Old Target \* (Actual Time of Last 2016 Blocks / 20160 minutes)

- New Target: 新しい難易度ターゲット
- Old Target: 古い難易度ターゲット
- Actual Time of Last 2016 Blocks: 過去 2016 ブロックの生成時間
- 20160 minutes: 2 週間分の時間（10 分/ブロック \* 2016 ブロック）

制約条件

- ターゲットが極端に動きすぎないように、調整の際、最大 4 倍、最小で 1/4 以内になるようになっている

まとめ

- Difficultyターゲットは、ビットコインネットワークが常に10分間隔でブロックを生成するように調整されている。この調整は、2週間ごと（2016ブロックごと）に行われ、コンピュータの進化やマイニング参加者の変動に対応し、ネットワークの安定性を保つために重要である。また、ターゲットの変動が極端にならないように制約が設けられている。

出典・参考
https://en.bitcoin.it/wiki/Difficulty

## マイニングに成功したら

ブロックの伝搬

- 候補ブロックが正しい新しいブロックとして生成される
  - マイニングに成功すると、そのブロックは新しいブロックとしてネットワークに認識される。
- 他のノードに伝搬する必要性
  - 他のマイナーも同時期にマイニングに成功する可能性があるため、いち早く自分のブロックを伝搬させる。
  - 他のブロックが先にネットワークに採用されると、自分のブロックが無効になり、報酬を失う可能性がある。


伝搬の方法

- ピアに送信する
  - 自分のブロックを他のノード（ピア）に送信する。
  - ピアはそのブロックを受け取り、検証し、自分のブロックチェーンに追加し、さらに他のピアに伝搬する。
  - ピアが異なるネットワークに所属している場合でも、ブロックはコピーされて繋がれる。


プロトコル

- TCP/IPプロトコルを使用

  - ネットワーク上でブロックを伝搬させるためにTCP/IPプロトコルを使用する。
  - ping pongメッセージを使ってノード間の接続を維持する。

- メッセージヘッダの構造

  - メッセージヘッダは以下の形式で構成される：
    - 開始文字列（4バイト）: ネットワークの種類を示すマジックバイト。例: メインネットの開始文字列はf9beb4d9。
    - コマンド名（12バイト）: ペイロードに含まれるメッセージタイプを識別するASCII文字列。例: version\0\0\0\0\0。
    - ペイロードサイズ（4バイト）: ペイロードのバイト数。最大32MiB。
    - チェックサム（4バイト）: ペイロードのSHA256(SHA256(ペイロード))の最初の4バイト。ペイロードが空の場合は0x5df6e0e2。

  - メッセージヘッダの例
    - verackメッセージ（ペイロードなし）のメインネットメッセージヘッダの16進ダンプ：
    - f9beb4d9: 開始文字列
    - 76657261636b000000000000: コマンド名（verack）とヌルパディング
    - 00000000: ペイロードサイズ（0バイト）
    - 5df6e0e2: チェックサム
    - Open SSL のライブラリ関数を用いている
    - 詳しくはhttps://en.bitcoin.it/wiki/Protocol_documentation

Livelock

- ブロック生成後の待機
  - ブロックが生成された後、各ノードはランダムな時間待機する。
  - 他のノードが生成したブロックを読む時間を作る。

- ライブロックとは
  - 多くの重複する共有ロックが互いに干渉し続けるため、排他的ロックの要求が繰り返し拒否される状況。
  - 長所
    - フォークの発生を防ぐ。
  - 短所
    - コンセンサスの時間がかかる。

まとめ
- マイニングに成功した場合、そのブロックをいち早く他のノードに伝搬させることが重要である。ブロックの伝搬にはTCP/IPプロトコルを使用し、メッセージヘッダを適切に構築して送信する。また、Livelockを防ぐための待機時間を設けることで、ネットワーク全体のコンセンサスを効率的に行う。これにより、ブロックチェーンの信頼性と一貫性が保たれる。

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch12_mining.adoc#L1119
https://en.bitcoin.it/wiki/Protocol_documentation#ping
https://developer.bitcoin.org/reference/p2p_networking.html

## 新しいブロックの検証

検証の目的
- 新しいブロックがネットワークに伝搬される前に、各ノードはそのブロックが正しいものであるかどうかを独立に検証する。これにより、ブロックチェーンの整合性とセキュリティが保たれる。

検証の手順

- 各ノードは以下の手順に従って新しいブロックを検証する：
  - ブロックのデータ構造が正しいことの確認
    - ブロックヘッダとトランザクションリストが正しい形式であることを確認する。
  - ブロックハッシュがターゲットより小さいことの確認
    -  ブロックヘッダのハッシュ値が設定された難易度ターゲット以下であることを確認し、適切な作業証明（Proof of Work, PoW）が行われたことを確認する。
  - ブロックのタイムスタンプの確認
    - ブロックのタイムスタンプがノードが持つ現在の時間より2時間未来の時間よりも小さいことを確認する。
    - タイムスタンプが2時間以内の誤差であれば許容される。
  - ブロックサイズの確認
    - ブロックサイズが1MB以下であることを確認する。
  - Coinbaseトランザクションの確認
    - 最初のトランザクションのみがCoinbaseトランザクションであることを確認する。
  - すべてのトランザクションが検証を満たすことの確認
    - ブロックに含まれるすべてのトランザクションが次の条件を満たすことを確認する：
    - トランザクションの構造が正しいこと
    - トランザクションサイズが上限（現在100KB）以下であること
    - トランザクションロックタイム（nLockTime）が適切であること
    - 空のトランザクションでないこと
    - 重複するトランザクションIDがないこと
    - 入力の総額が出力の総額を超えていないこと
      - トランザクションが新規コインを生成していないことを確認する。
    - すべての入力の署名が有効であること
      - 各入力トランザクション出力の所有権を正しく検証できる署名となっているか確認する。
    - すべての入力トランザクション出力が使用可能であること
      - 二重支払いがなく、入力として参照される出力が未使用であることを確認する。

検証の重要性

  - 全ノードによる検証
    - 各ノードが独立にブロックを検証することで、ブロックチェーンの不正行為を防ぐ。
    - もし受け取ったノードがブロック内の情報を書き換えた場合、他のノードの検証に失敗し、そのブロックは拒否される。

  - フォークへの対応
    - 受け取る直前に他のノードもマイニングに成功した場合、ネットワークにフォークが発生する。
    - セカンダリーチェーンにつなげるが、最終的には長さがメインチェーンを超えた場合にそのチェーンがメインチェーンとみなされる（Longest Chain Rule）。
    - フォークが解消され、メインチェーンが確定するまでの間、ネットワークは一時的に分岐することがあるが、最も作業量の多いチェーンが最終的にメインチェーンとなる。

まとめ
- 新しいブロックの検証は、ビットコインネットワークのセキュリティと信頼性を維持するための重要なプロセスである。各ノードが独立に検証を行い、正しいブロックのみがネットワークに伝搬されることで、不正行為を防ぎ、健全なブロックチェーンを維持する。

出典・参考
https://en.bitcoin.it/wiki/Block_timestamp

## ブロックのチェーンの組み立てと選択

検証後の処理

- ブロックが検証されると、次にそのブロックがチェーンに追加されるかどうかが試行される。無効なブロックは破棄される。

ノードのブロックセット

- 各ノードは以下の3つのブロックセットを持つ：

  - メインチェーン:
    - 現在の最大長を持つチェーン。
  - セカンダリチェーン:
    - メインチェーンから分岐したチェーンで、将来的にメインチェーンに置き換わる可能性があるため保持される。
  - オーファンブロックプール:
    - 親ブロックが不明なブロックを一時的に保存するプール。

チェーンの組み立て

- ブロックの属するチェーンの判断
- 新しいブロックを受け取ったノードは、そのブロックの「Previous Block Hash」を見て、どのチェーンに属するものかを判断する。

  - メインチェーン:
    - 多くの場合、新しいブロックはメインチェーンの最新ブロックに接続される。
  - セカンダリチェーン:
    - セカンダリチェーンを伸ばすブロックを受け取ることもある。これにより、結果としてメインチェーンが置き換わることがある。最長チェーンが入れ替わると、セカンダリチェーンがメインチェーンになる。

- オーファンブロック
- 親ブロックが見つからないが検証を通るブロックを受け取った場合、そのブロックはオーファンブロックプールに保存される。

  - オーファンブロックの原因:
    - ブロック受け取り順序が逆になった際によく生じる。例えば、親ブロックが後で到着する場合など。
  - オーファンブロックの処理:
    - 親チェーンの情報が届くまで、オーファンブロックプールに保持される。親チェーンの情報が届くと、そのブロックを正しいチェーンに接続する。

まとめ
- 新しいブロックの受け取り後、ノードはそのブロックがどのチェーンに属するかを判断し、適切なチェーンに追加する。メインチェーンが最も長いチェーンとして優先されるが、セカンダリチェーンがメインチェーンに置き換わることもある。親ブロックが不明なオーファンブロックは、一時的にオーファンブロックプールに保存され、親ブロックが確認され次第、正しいチェーンに追加される。これにより、ネットワーク全体で整合性のあるブロックチェーンが維持される。

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch10_network.adoc#L1227

## ブロックチェーンフォーク

# フォークの種類

ブロックチェーンにおけるフォークには以下の三種類がある：

1. **一時的なフォーク**
2. **ソフトフォーク**
3. **ハードフォーク**

# 一時的なフォーク

一時的なフォークは、伝達ラグによって発生する。ブロックチェーンネットワーク全体に新しいブロックの情報が同時に伝搬されることは不可能であるため、一時的に複数の有効なブロックチェーンが存在することがある。

# フォークの具体的なプロセス

- 異なるマイナーが同時期にブロックを見つける。
- 各マイナーが新しいブロックをネットワークに流す。
- 一部のノードは特定のブロックを受信し、別のノードは別のブロックを受信する。
- 結果として、ネットワーク上に複数の有効なブロックチェーンが一時的に共存する状態（フォーク）が発生する。

# フォークへの対処

- **ノードの対応**:
  - ノードは複数のチェーンを一時的に保持する。
  - メインチェーン（最長の有効チェーン）。
  - セカンダリチェーン（フォークされたチェーン）。
- **次のブロックの発見**:
  - 次のブロックが見つかると、作業証明の総量が大きいチェーンが選ばれメインチェーンとなる。
  - 作業証明が小さいチェーンは無効化され、破棄される。

# ソフトフォーク

ソフトフォークは、ブロックチェーンの仕様変更が行われる際に発生する。これは、1本のチェーンを維持したまま、新しい仕様に移行する方法である。しかし、仕様変更のタイミングにずれが生じると、以下の状況が発生する：

- 一部のマイナーが旧仕様のまま新ブロックを生成する。
- 他のマイナーは新仕様に基づいてブロックを生成する。
- 結果として、一時的に異なる仕様のブロックがネットワーク上に存在することになる。

# ハードフォーク

ハードフォークは、仮想通貨の仕様が議論され、複数の方式が提案された結果、コミュニティ内で合意が取れず、異なる仕様のチェーンが併存する時に発生する。

- **例**:
  - 2017年にビットコインがビットコインキャッシュ（BCH）とハードフォークした。

# ハードフォークの対処

- コンセンサスルールの変更が発生した場合、複数の互換性のないブロックチェーンが長期間並存することになる。
- 異なるルールを採用する深刻なフォークが発生すると、ネットワークの分裂が生じる可能性がある。
- そのような事態を避けるため、重要な変更は事前に合意形成が行われる。

# フォークの長期化への対策

- 重要な仕様変更やルール変更は事前に広く議論され、合意を得ることが重要である。
- コンセンサスを得た上で変更を行うことで、ネットワークの分裂を防ぐ。

# まとめ

ブロックチェーンフォークは、ネットワークの運用や仕様変更に伴って発生する。各ノードはフォークが発生した場合、複数のチェーンを一時的に保持し、作業証明の総量が大きいチェーンをメインチェーンとして選ぶ。一時的なフォークはネットワークの伝搬遅延によって自然に解消されるが、ソフトフォークやハードフォークでは事前の合意形成が重要となる。これにより、ネットワークの整合性と安定性を維持することができる。

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch12_mining.adoc#L1736
https://www.oanda.jp/lab-education/cryptocurrency_basic/cryptocurrency15/blockchain_fork/

## マイニングとハッシュ化競争

# ハードウェアの進化

ビットコインのマイニングは、ハードウェアの進化に伴い、次のように特化したデバイスに移行してきた：

1. **CPU（Central Processing Unit）**:
   - 一般的なパソコンに搭載されている処理装置。
   - 初期のマイニングはCPUを使用して行われていた。

2. **GPU（Graphics Processing Unit）**:
   - 主に画像処理を行うためのプロセッサだが、GPGPU（General-Purpose computing on Graphics Processing Units）技術により、並列計算が高速に行える。
   - 2011年頃からGPUを使用したマイニングが一般化した。

3. **FPGA（Field-Programmable Gate Array）**:
   - 回路をプログラム可能なデバイス。
   - GPUよりも効率的にマイニングを行うことができる。

4. **ASIC（Application-Specific Integrated Circuit）**:
   - 特定の用途に特化した専用回路。
   - 2013年からASICを使用したマイニングが主流となり、他のハードウェアよりも圧倒的に高い効率を持つ。

# ハッシュレート

- **ハッシュレート**: ビットコインネットワーク全体で毎秒生成されるハッシュの総数を指す。
  - ハッシュレートが高いほど、ネットワークのセキュリティが強化される。
  - ハードウェアの進化とマイニングノードの増加により、ハッシュレートは指数関数的に増加している。

# 難易度の増加

- ハッシュレートの増加に伴い、ビットコインの難易度（difficulty）も自動的に調整されて増加する。
  - 難易度の増加は、ブロック生成時間を平均10分に保つためのメカニズム。
  - ハッシュレートが高くなると、同じブロックを見つけるのに必要な計算量が増えるため、難易度が上昇する。

# 新規参入の困難さ

- 現在のビットコインマイニングは、特化した高性能なハードウェア（ASIC）が主流であり、個人が手元のPCでマイニングを行うのは非常に難しくなっている。
  - 専用のマイニングハードウェアを持つ大規模なマイニングファームが競争を優位に進めている。
  - 新規参入者は、初期投資が高く、既存の大規模マイニング業者と競争するのは困難。

# まとめ

ビットコインのマイニングは、ハードウェアの進化に伴い、CPUからGPU、FPGA、そしてASICへと移行してきた。ハッシュレートの増加により、ビットコインネットワークのセキュリティは強化されたが、それに伴って難易度も増加している。これにより、個人が手元のPCで気軽にマイニングを行うのは難しくなり、専用ハードウェアを持つ大規模なマイニングファームが主流となっている。

出典・参考
https://d-central.tech/asic-vs-fpga-vs-gpu-vs-cpu-understanding-the-differences/

## マイニングプール

# 概要

マイニングプールは、複数のマイナーが協力してマイニングを行い、その報酬を分配する仕組みである。これにより、各マイナーは個別にマイニングするよりも平均的な報酬を得やすくなる。

# 収益の配分方式

# PPLNS（Pay Per Last N Share）

- **特徴**:
  - マイナーが最近提出したシェア（証明作業の単位）に基づいて報酬を分配する。
  - 長期的な貢献を重視するため、短期間の参加よりも長期間の安定した貢献を奨励する。
  - プールホッピング（報酬の支払いが予想されるタイミングでのみ参加し、報酬を得た後に離脱する行為）を防止する。
- **欠点**:
  - プールがブロックを発見するまで報酬が確定しないため、報酬の受け取りに遅延が生じる。

# PPS（Pay Per Share）

- **特徴**:
  - プール全体がマイニングに成功しない場合でも、提出したシェアに応じて報酬を受け取ることができる。
  - 収入が安定するが、手数料が高くなる傾向がある。

# 初のマイニングプールサービス

- **SlushPool**: 初めてのマイニングプールサービス。

# マイニングプールのプロトコル

- **Stratum Protocol**:
  - プール参加者とのやり取りの方法やルールを規定するプロトコル。
  - 現在、ほとんどのマイニングプールはこのプロトコルに従って動作している。

# マイニングプールの種類

# マネージドプール

- **特徴**:
  - 管理者がいるマイニングプール。
  - 管理者がプールのプロトコル管理やフルノードのメンテナンスを行う。
  - 報酬は管理者が受け取り、参加者に分配する。
  - 管理者は報酬の一部を手数料として受け取る。

# P2PPool

- **特徴**:
  - 管理者による不正が行われる可能性を排除するため、中央管理者が存在しない。
  - シェアチェーンと呼ばれる小型ブロックチェーンを使用し、参加者はこれを掘る。
  - ビットコインブロックチェーンよりも低い難易度（Difficulty）が設定される。
  - ビットコインブロックチェーンの難易度を充足させるブロックが発見されると、それを採用する。
  - 報酬の分配ルールもシェアチェーンで管理され、特定の誰かが不正できない仕組みになっている。

# クラウドマイニング

- **特徴**:
  - 既にマイニング用の設備を持っている事業者に費用を支払い、その分の利益配当を受け取る仕組み。
  - 投資信託のようなもので、自分の購入したハッシュパワーに応じた利益を得る。
  - 少額から始められ、マシンなしですぐに参加できる。
  - 居住地にとらわれず参加可能。
  - 電気代が高い地域に住んでいても、電気代の安い地域にあるデータセンターを利用してマイニングに参加できる。

# まとめ

マイニングプールは、個々のマイナーが協力してマイニングを行い、報酬を分配する仕組みであり、平均的な収入を得やすくする。収益の配分方式には、PPLNSとPPSがあり、それぞれに特徴と欠点がある。マイニングプールのプロトコルとしてはStratum Protocolが広く使用されている。マネージドプールとP2PPoolの違いやクラウドマイニングの利点についても理解することが重要である。

出典・参考
https://crypto.watch.impress.co.jp/docs/serial/dmmcourse/1136456.html
https://magazine.ginco.io/post/mining_basicknowledge_02/
https://bitcoin.dmm.com/column/006#:~:text=PPLNS%EF%BC%88Pay%20Per%20Last%20Shares,%E3%81%AE%E3%82%92%E9%81%BF%E3%81%91%E3%82%8B%E3%81%9F%E3%82%81%E3%81%A7%E3%81%99%E3%80%82

## コンセンサス攻撃

# 概要

コンセンサス攻撃とは、ビットコインなどのブロックチェーンネットワークにおいて、マイナーやマイニングプールが不正または破壊的な目的でハッシュパワーを使用し、ネットワークのセキュリティや利用可能性を妨害する行為全般を指す。

# 51%攻撃（ハッシュレート攻撃、マジョリティーアタック）

- **概要**:
  - 攻撃者がネットワークのハッシュパワーの過半数を掌握し、ブロックチェーンの操作を試みる。
  - 51%のハッシュパワーがなくても、過半数に近いハッシュパワーで攻撃が成功する可能性がある。

- **攻撃の種類**:
  - **二重支払い攻撃**:
    - 攻撃者が同じコインを二度使用することで、既に支払ったと見せかけて実際には支払いを無効にし、商品やサービスを無料で得ることができる。
  - **サービス拒否（DoS）攻撃**:
    - 攻撃者が特定のビットコインアドレスへのトランザクションをブロックチェーンに含めないようにし、そのアドレスのトランザクションを無効化する。

# 一時的ブロック隠匿攻撃

- **概要**:
  - 攻撃者がブロックを生成した後、そのブロックをネットワークにブロードキャストせずに隠匿することで、見かけ上は唯一つのチェーンのままであるが、実際には分岐が発生する。
  - 詳しくはこちら：https://qiita.com/stnk20/items/297dafff76fd330d8f90

- **攻撃の具体例**:
  - **Monacoinへの攻撃**:
    - MonacoinはLitecoinをベースにした仮想通貨で、ブロック生成時間は90秒。
    - 攻撃者が事前に隠匿したチェーンを伸ばし、その後に公開することで、既存のパブリックチェーンを無効化。
    - 結果として、取引所が攻撃者に対して換金先の通貨を支払うと同時に、無効化されたMonacoinの利用も払い戻すこととなり、二重支払いが発生した。

- **理由**:
  - 小さいチェーンは計算能力の確保が容易で、取引の確定が確率的であるため、攻撃が成立しやすい。

# 対策と防御

- **確認数の引き上げ**:
  - 二重支払い攻撃や一時的ブロック隠匿攻撃を防ぐために、仮想通貨取引所などでは取引の確認数を引き上げることで、取引の確実性を高める。

- **マイニングプールの監視**:
  - マイニングプールが不正を行おうとする場合に備え、プールの動向を監視し、異常なハッシュレートの集中を検出する。

- **ネットワークの分散化**:
  - ハッシュパワーが特定のマイナーやプールに集中しないように、ネットワークの分散化を促進する。

# まとめ

コンセンサス攻撃は、ビットコインなどのブロックチェーンネットワークにおいて、ネットワークのセキュリティや利用可能性を妨害する重大な脅威である。特に51%攻撃や一時的ブロック隠匿攻撃は、ネットワークの信頼性を大きく揺るがす可能性がある。これらの攻撃を防ぐためには、ネットワークの分散化や取引の確認数の引き上げ、マイニングプールの監視などの対策が重要である。

出典・参考
https://github.com/bitcoinbook/bitcoinbook/blob/6d1c26e1640ae32b28389d5ae4caf1214c2be7db/ch12_mining.adoc#L1580
田中覚. "ブロックチェーンの安全性と運用にまつわる諸問題." 2020

## まとめ

# コンセンサスの確立方法

- **新しいブロックの検証**:
  - 各ノードは、受け取った新しいブロックを共通のルールに基づいて検証する。
  - もし検証を通らないブロックが伝搬されても、多くのノードで無効と判断される。
  - 最長のブロックチェーンが正当なものとして残るため、マイナーは正確で長いチェーンを作るインセンティブを持つ。

# マイニングの仕組み

- **PoW（Proof of Work）**:
  - 計算問題の解を見つけることで報酬を得る。
  - 2024年3月現在、1ブロックあたり6.25BTCの報酬がある（1BTC＝約1000万円で、約6250万円の価値）。

- **マイナーのインセンティブ**:
  - マイニング報酬を得るために、すべてのノードは正しい振舞いをする。
    - 正しいブロックを作成し、正しくブロックを検証する。

# コンセンサス攻撃

- **51%攻撃**:
  - 一部のマイナーがネットワークのハッシュレートの過半数を掌握すると、コンセンサスメカニズムを破壊することが可能。
  - これにより、二重支払い攻撃や特定トランザクションの拒否などが可能になる。

- **マイニングプールの役割**:
  - マイニングプールが大きなハッシュレートを持つと、攻撃を行う可能性があるが、P2PPoolなど管理者不在の方法も考案されている。

# 重要なポイント

1. **ブロックの検証とルールの統一**:
   - すべてのノードが共通のルールに従って新しいブロックを検証し、正しいブロックのみが承認される。
   
2. **PoWと報酬の仕組み**:
   - マイナーは計算問題の解を見つけることで報酬を得る。これが正しい行動を促すインセンティブとなる。
   
3. **コンセンサス攻撃のリスク**:
   - ハッシュレートの過半数を掌握することでネットワークのセキュリティを脅かす可能性がある。
   - P2PPoolなどの新しい方法がこのリスクに対処する手段として提案されている。

ビットコインネットワークは、各ノードが正確で公正な検証を行うことで成り立っている。マイナーは報酬を得るために正しい行動をとり、ネットワークのセキュリティと信頼性を維持する。一方で、コンセンサス攻撃のリスクも存在し、それに対する対策が進められている。