# マイニングとコンセンサス

## 概要

- 前項によりブロックチェーンは改ざんできないことはわかったが、新しいブロックに含まれる情報がなぜ正しいものがはいるのか、その正しさはどのように全体でコンセンサスを得るのかなどをここで説明する

- 合意のプロセス
  - [分散化コンセンサス](#分散化コンセンサス)

- トランザクション検証
  - [独立したトランザクション検証](#独立したトランザクション検証)
  - [マイニングノード](#マイニングノード)
  - [ブロックへのトランザクション集積](#ブロックへのトランザクション集積)
  - [トランザクション手数料](#トランザクション手数料)
  - [Coinbaseトランザクション概要](Coinbaseトランザクション概要)
- マイニング
  - [マイニング報酬と手数料](#マイニング報酬と手数料)
  - [Coinbaseトランザクションの構造](#coinbaseトランザクションの構造)
  - [ブロックヘッダの構築](#ブロックヘッダの構築)
  - [ブロックのマイニングーProof-of-Workアルゴリズム](#ブロックのマイニングーproof-of-workアルゴリズム)
  - [マイニングのプログラム例](#マイニングのプログラム例)
  - [difficultyターゲットの表現](#difficultyターゲットの表現)
  - [difficultyターゲットの更新](#difficultyターゲットの更新)
  - [マイニングに成功したら](#マイニングに成功したら)
- ブロック検証
  - [新しいブロックの検証](#新しいブロックの検証)
  - [ブロックのチェーンの組み立てと選択](#ブロックのチェーンの組み立てと選択)
  - [ブロックチェーンフォーク](#ブロックチェーンフォーク)
  - [マイニングとハッシュ化競争](#マイニングとハッシュ化競争)
  - [マイニングプール](#マイニングプール)
  - [コンセンサス攻撃](#コンセンサス攻撃)
  
## 分散化コンセンサス

- どのようにして中央管理者なしにシステムが成り立つのか
  - 中央集権型のシステムの場合はその運営者を信用している
  - 例：Visaの支払いではVisa社を信用することが前提である
  
- そもそもコンセンサスアルゴリズムとは？
  - 分散型ネットワークにおいてノード間で「正しい」ブロックチェーンのバージョンを選択するためのアルゴリズム
  - ビットコインのブロックチェーンにおいては、ビットコインフルノードはジェネシスブロックから全てのブロックをダウンロードし、そのPoWが正しいか検証をすることで正しいチェーンであることを確認する。接続先のノードが偽の情報を流すことも考えられるため、複数のノードと接続し、接続先のノードによって異なるブロックチェーンが返ってくるケースでは、よりPoWが行われている方（長いチェーン）を「正しい」チェーンとして採用する
  - PoWやPoS自体が「コンセンサスアルゴリズム」として紹介されることは多いが、それ実際はブロックの有効性決定の一基準であり、むしろ一種のデジタル署名に近い概念である
  
- - 分散化されたコンセンサス
  - 概して、個々が独立して動いていても全体として最適に動くこと
  - 創発的コンセンサスとも呼ばれるが、ここでいう「コンセンサス」は分散しているノードの状態を一致させるための「ビザンティン合意問題」などで使われる「コンセンサスアルゴリズム」とは「コンセンサス」の概念が違うなど、多義的な意味を持つ用語なので文脈を踏まえた注意が必要

- 主に以下の4つの相互作用で成り立っている

- 独立したトランザクション検証
  - すべてのフルノードは、包括的なリストに基づいて検証可能
  - 要は、一つ一つのノードで一つの検証方法が共有されておりそれぞれで検証できるようになっている

- 独立したトランザクション集積
  - PoWアルゴリズムによる計算と結びついた、マイニングノードによるブロックへのトランザクションの集積
  - 要は、マイニングノードが自由にブロックに入れるトランザクションリストを作ってよい、ということ

- 独立した新規ブロック検証とブロックチェーンへの埋め込み
  - すべてのノードによって新しいブロックが検証され、そのブロックが自身が持つブロックチェーンに取り込まれる

- 独立したブロックチェーン選択
  - 個々のノードでPoWを通じて証明された、最も多くの累積計算量を持っているブロックチェーンが選ばれる
  - 要は、フォークしているブロックチェーンがいくつかある中でどれを選ぶかは、個々のノードごとに認識しているブロックチェーンの中で累積計算量を見て決めている、ということ

## 独立したトランザクション検証

- 各ノードはトランザクションを受信すると、各トランザクションがネットワークのルールに従っていることを確認する
  
- ノードが確認する主な事項は以下
  
 1. そのトランザクションのインプットを過去に支払ってないこと
二重支払いの防止。支払い済みのインプットを再度支払うことはできない

 2. そのインプットの合計額がアウトプットの合計額以上になっていること
新たにビットコインが作成されてないかを確認する(coinbaseトランザクションは例外)

 3. ScriptSigが前のScriptPubKeyのアンロックに成功していること
連結したスクリプトが有効であることを確認する(ほとんどすべてのトランザクションにおいてはScriptSigにある1つ以上の署名が有効であると確認することを意味する)

- インプットの支払い状況の確認
  - 二重支払い防止のため、ノードは各インプットが存在すること及び過去に使われてないことを確認する(UTXOセットにアクセスし、UTXOを追跡することであるインプットが二重支払いかどうか検証可能)

- インプットの合計額とアウトプットの合計額の確認
  - ノードはインプットの合計がアウトプットの合計以上であることも確認する(これによりトランザクションが新たなコインを作成することを防ぐ)(後述するcoinbaseトランザクションは例外)

- 署名の確認
  - トランザクションは通常は1インプットにつき少なくとも1つ以上の署名を持つ。ここで署名ハッシュを取得する部分において、署名はScriptSigの一部であるためにトランザクションのシリアライズをハッシュすることができない(署名はScriptSigの一部であり、署名自体に署名できないから)
  - 代わりに、インプットごとに異なる署名ハッシュを計算する(署名前にトランザクションを変更する)
   1. 全てのScriptSigを空にする
   2. 署名されるインプットのScriptSigを前のScriptPubKeyに置き換える
   3. ハッシュタイプを付加する(4バイトのハッシュタイプを末尾に加えることで署名が正当性を認める内容を指定する)
  
- このような手順を踏むことでトランザクション検証プロセスが行われる。署名ハッシュのアルゴリズム自体は非効率的で無駄が多いため、Segwit以降は所謂二次ハッシュ問題は別手法により解決されている

## マイニングノード

- ノードのうちマイニングを行っているノードで、マイナーと呼ばれる。マイナーの主な仕事はPoWを解いて次のブロックを見つけることである
  - 必ずしもフルノードでなくともよい

- マイニングプールではフルノードなしにマイニングする
  - 一般的には、フルノードとなりすべてブロックの検証が可能な状態のブロックチェーンに対してマイニングする

- 万が一マイニングに成功し生成ブロックが他のノードで検証に失敗するとブロックチェーンに取り込まれなくなってしまう

- マイニングノードはマイニングに成功すると、マイニング報酬とそのブロックに含まれているトランザクションの手数料すべてを受け取る

- 新規ブロックが他のノードから伝搬された場合、現在のマイニングに負けたことを意味するため、次のブロックのマイニングを始める必要がある

## ブロックへのトランザクション集積

- マイニングノードは候補ブロックを作る
  - 次の新しいブロックとしてトランザクションのリストを持ったブロック

- トランザクションは自身のトランザクションプールから選ぶ

- 候補ブロックのナンス値を見つける（PoW）(ナンス値はマイナーがPoWを探す際に変更される)

- 元々は候補ブロックに入れるトランザクションは優先度が決められていた
  - その優先度に従って候補ブロックに入れるトランザクションが決められた

## トランザクション手数料

- トランザクション手数料の意義
  - そもそもマイナーにはブロックを小さく保とうとする明確な動機が存在する(ブロックにトランザクションを追加すればするほどブロック間のマイニング競争で不利になるから)
  - しかしながら、ブロックにトランザクションを追加するたびにマイナーが得る収入が増えるとすると、マイナーの競争力の低下を補うインセンティブが発生する
  - これはあくまでひとつの説明だが、実際に効力をなしている

- ビットコインのコンセンサスルールのひとつに、任意の非coinbaseトランザクションにおいてはインプットの合計≧アウトプットの合計というものがある。トランザクションのコストがゼロであるならば、マイナーがトランザクションをブロックに取り込むインセンティブがなくなるから
  
- このように、インセンティブ設計ひとつ取っても中央管理者抜きでビットコインシステムが成り立つ基盤となっている
  
- 元々はCoin Age Priorityというトランザクションの手数料と優先度を定めたロジックが存在したが、今はない。現在では、トランザクションを早く通す(早くブロックに取り込まれる)ためにはいくつかの要因があるが、手数料の支払い額が優先度の大きな判断基準となっている

## coinbaseトランザクション概要

- 各ブロックの最初に要求されるトランザクションをcoinbaseトランザクションと呼ぶ

- マイナー自身への支払いとなる、ブロック内の他のトランザクションの全ての手数料とブロック報酬が含まれる
  
- インプットはcoinbaseと呼ばれるデータ領域になっている
  - マイニング報酬は無から生み出される、すなわち対応するUTXOはない
  - エクストラナンスとしても使用される
- アウトプットはマイナーのアドレスへ（公開鍵を含むロッキングスクリプト）

## マイニング報酬と手数料

- マイニング成功時に得られる報酬は、マイニング報酬＋手数料

- マイニング報酬

  - マイニング報酬とはすなわちビットコインの新規発行

  - 210,000ブロックごとに報酬は半減する

  - 約4年、1ブロック=10分

  - 最初50BTCで、2020年5月には6.25BTCになった。2024年の半減期は3.125BTCになる

  - 2024/02現在1BTC≒800万円なので約5,000万円

  - 最終的にマイニング報酬が0になるのは2140年ごろ、そのころになると1satoshiを切る。そのとき総発行量は2100万BTCとなる

- 手数料

  - Total Fees = Sum(Inputs) – Sum(Outputs)

  - ブロック内に入れるトランザクション全体の手数料総和

## coinbaseトランザクションの構造

- インプットは必ず一つのみ、その一つのインプットの前のトランザクションIDは32バイトの00である、その一つのインプットの前のトランザクションインデックスはffffffffである、という3つの条件がcoinbaseトランザクションか否かを決定づける

- coinbaseトランザクションのインプットはアンロッキングスクリプトの代わりに任意のデータを入れられる

  - GenesisブロックのcoinbaseトランザクションのScriptSigは"04ffff001d0104455468652054696d65732030332f4a616e2f32303039204368616e63656c6c6f72206f6e206272696e6b206f66207365636f6e64206261696c6f757420666f722062616e6b73"
  - この文字列をdeccodeすると"The Times 03/Jan/2009 Chancellor on brink of second bailout for banks"という2009年1月3日付英国「Times」紙の見出しが現れる
  - これにより、Genesisブロックがその日以降作成されたことが証明される

  - 2バイト以上100バイト以下のデータならなんでもいい

## ブロックヘッダの構築

- ブロックヘッダはトランザクションの集まり、ブロックに含まれるトランザクションに関するメタデータ

- マイニングに成功した場合、ブロックヘッダを構築する必要がある
  - 普通のブロックヘッダ

  - マイナーが作成

  - 間違えると無効になってしまうので、間違えないように作成する必要がある
  
- Target PoWのDifficulty Target
- Nounce マイニングで求める値

| Size       | Field               | Description                                                       |
|------------|---------------------|-------------------------------------------------------------------|
| 4 bytes    | Version             | A version number to track software/protocol upgrades.             |
| 32 bytes   | Previous Block Hash | A reference to the hash of the previous (parent) block in the chain. |
| 32 bytes   | Merkle Root         | A hash of the root of the merkle tree of this block’s transaction. |
| 4 bytes    | Timestamp           | The approximate creation time of the block.                       |
| 4 bytes    | Difficulty Target   | The proof of work algorithm difficulty target for this block.     |
| 4 bytes    | Nonce               | A counter used for the proof of work algorithm.                  |

## ブロックのマイニングーProof-of-Workアルゴリズム

- トランザクションリストを選び、ブロックヘッダを構築したら、候補ブロックに対してあとはやることはマイニングのみ
- ナンス値(4 bytes)を発見する
- ブロックハッシュの頭にゼロがいくつか並ぶもとの文字列を求める
  - ブロックヘッダのダブルハッシュ値(SHA256 2回)
- ゼロがいくつ必要かはその時点のターゲットによる
- ハッシュ値がターゲット未満になるようなナンス値を探す
  - 例えば
  - 0x0000000000000003A30C00000000000000000000000000000000000000000000
  - というターゲットの場合、ブロックハッシュの値がこの値より小さい必要がある
  
## マイニングのプログラム例

- ナンス値を変えてブロックハッシュを求めてターゲット以下になるか、ということを繰り返して行
う以外方法がない
  - ハッシュ関数は不可逆で、元の値を少しでも変えるとハッシュ値は大幅に変わる
- Pythonの実装例：

```python
def proof_of_work(difficulty):
    # nonceは4byte
    for nonce in range(2 ** (4 * 8)):
        header = get_header(nonce)
        blockhash = double_hash(header)
        if blockhash < difficulty:
            return nonce
    raise NotFoundException()
```

## difficultyターゲットの表現

- 異なるターゲット同士を比較しやすくするために生まれたのがdifficultyという概念
  
- PoWはビットコインの全てのブロックヘッダのハッシュが一定のターゲットを下回らなければいけないという要件。そのターゲットはビットフィールドから直接計算される256ビットの数値
- ビットフィールドは、実際には2つの異なる数値であり、1つ目は指数(exponent)で最後の1バイト。2つ目は係数(coefficient)で、残りの3バイトをリトルエンディアンでencodeした数値。これら2つの数値からターゲットを計算する式は

target = coefficient × 2^(8 × (exponent - 3))
  
## difficultyターゲットの更新

- ブロック生成時間が10分に保たれるようにターゲットが一定間隔で調整される

- 「10分」という間隔は、何十年にもわたって保ちたい

  - コンピュータの急激な進化にも耐えられるようにする

  - マイニング参加者、コンピュータ台数も変化する
  
- ターゲットはブロックが10分間隔で生成されるように2週間ごと（2016ブロックごと）に調整され
る

> New Target = Old Target * (Actual Time of Last 2016 Blocks / 20160 minutes)

- ターゲットが極端に動きすぎないように、調整の際、最大4倍、最小で1/4以内になるようになっ
ている

## マイニングに成功したら

- 候補ブロックが正しい新しいブロックとして生成できたということになる

- これは、いち早く他のノードに伝搬すべき
  - 他のマイナーも同時期にマイニングに成功している可能性があり、そちらが採用されてしまうと自分のマイニングしたブロックが無効になってしまうため
  - もらえるはずだった報酬がもらえなくなってしまう

## 新しいブロックの検証

- 各ノードは受け取った新規ブロックについて、他のノードへ伝搬する前に独立に検証を行う

- **ブロックのデータ構造が正しいこと**

- **ブロックハッシュがターゲットより小さいこと**

- **ブロックのタイムスタンプが、ノードが持つ時間より2時間未来の時間よりも小さいこと**

- **ブロックサイズが受け入れられる制限内であること**

- **最初のトランザクションのみがcoinbaseトランザクションであること**

- **ブロックに含まれるすべてのトランザクションが、「独立したトランザクション検証」のチェックリストをすべて満たすこと**

- この検証を全ノードが行うことで不正が行われないようになっている
  - もし受け取ったノードがブロック内の情報を書き換えたとしても他のノードでの検証に失敗する
  - もし受け取る一瞬前に自分もマイニングに成功していた場合
    - メインチェーンではなくセカンダリチェーンにつなげる

## ブロックのチェーンの組み立てと選択

- ブロックの検証後、チェーンへの追記が試行される
  - 無効なブロックは破棄される

- 各ノードは3つのブロックセットを持つ
  - メインチェーン
    - 最大長を持つ

  - セカンダリチェーン
    - メインチェーンから分岐した兄弟チェーンも、将来的にメインチェーンに置き換わる
可能性があるため保持される

- オーファンブロックプール
  - 親が不明なブロック

- Previous Block Hashを見てどのチェーンに属するものか判断する
  - 多くの場合はメインチェーンの最新ブロックに

- セカンダリチェーンを伸ばすブロックを受け取り、結果としてメインチェーンが置き換わることも
ある
  - 最長チェーンが入れ替わる

- 親が見つからないが検証を通るブロックを受け取ると、親チェーンの情報を受け取るまでの間
オーファンブロックプールへ保存される

- オーファンブロックはブロック受け取り順序が逆になった際によく生じる

## ブロックチェーンフォーク

- 伝達ラグによってフォークがおこる．世界中に存在するノードで同時に伝搬を完了させるのは不可
能．

## マイニングとハッシュ化競争

- CPU → GPU/FPGA (2011年) → ASIC (2013年) と特化ハードウェアへ移行してきた．

  - CPU： 普通のパソコンに搭載

  - GPU： GPGPUで高速な並列計算が可能

  - FPGA: 回路をプログラム可能

  - ASIC：マイニング専用回路

- ハッシュレート

  - ビットコインネットワーク全体の毎秒総生成ハッシュ数

- ハードウェアの進化とマイニングノードの増加により、指数関数的に増加している

- これに伴いdifficultyも増加するので、新規参入は困難
  - 現在では手元のPCで気軽にマイニングしても難しい

## マイニングプール

- 複数人でマイニングを分担する仕組み
- 複数人のマイナーを集めて一緒にマイニングを行い、報酬を分配する
- マイナーは報酬額は減るが、日々平均的な報酬を得られるようになる

- マネージドプール
  - 管理者がいるマイニングプール
  - 管理者がプールマイニングプロトコルの管理や、フルノードのメンテナンスなどを行う
  - 報酬は管理者が受け取って，参加者に分配する
  - 管理者は、報酬の一部を手数料として受けとる

- P2PPool
  - マネージドプールは管理者によって不正がなされる可能性もある

  - P2PPoolではシェアチェーンと呼ばれる小型ブロックチェーンのようなチェーンを用いて
参加者はシェアチェーンを掘る
    - ビットコインブロックチェーンより低いDifficultyが設定される
  - そのうち、ビットコインブロックチェーンでのDifficultyを充足させるブロックが発見されたら
それを採用する

  - 報酬の分配ルールもシェアチェーンで管理され特定の誰かが不正できなくなっている

## コンセンサス攻撃

- 特定のマイナーがハッシュレートの多くを占めていると、先端のブロック伸長をある程度操作す
ることが可能になる
  - 2ブロック分マイニングできるくらいのハッシュレートを持っていれば、1ブロック分のフォー
クは無効化できる

- 51%アタックと呼ばれる
  - 6ブロック以上を無効化できる可能性がある
  - 特定アドレスが関与する支払いを無効化するために意図的にフォーク
  - 51%というのは必ずしもハッシュレートの51%が必要というわけではない

- マイニングプールが不正を行おうとするとかなり問題が発生する

## まとめ

- 新しいブロック（トランザクション）が正しいといかにしてコンセンサスを得るか
  - 参加者全員が同じルールに基づいて検証を行っている
  - もしこの検証を通らないブロックを伝搬させようとしても他の多くのノードで無効と判断される
  - 最長ブロックチェーンが残っていくため、いち早く正しく長いチェーンを作ることがマイナーのインセンティブになっている

- マイニング
  - PoWの解を見つければ報酬を得られる

  - マイニング報酬を得たいがためにすべてのノードは「正しい」振舞いをする
    - 正しくブロックを作る
    - 正しくブロックを検証する

- コンセンサスアタック
  - ハッシュレートの多くの割合を一部の人が持ってしまうとコンセンサスメカニズムを破壊できる（51%攻撃）
  - マイニングプールがそれができる傾向があるが、P2PPoolなど管理者不在の方法も考案されている

