# 6章　ビットインネットワーク
## 概要
各ノードがどうつながって，どのような情報のやり取りをしているのかを見ていく
- [P2Pネットワークアーキテクチャ](#peer-to-peerネットワークアーキテクチャ)
- ノードのタイプと役割
- ノード間の接続
- ブロック情報の伝搬
- SPVノード
- ブルームフィルタ

## Peer-to-Peerネットワークアーキテクチャ
Bitcoinは，インターネット上でP2P (peer-to-peer)ネットワークを構成している

- P2Pネットワークとは
    - 世界中にあるノードがつながって運営されている
    - すべてのノードの役割が同じで特別なノードはない．
    - flatなトポロジーでつながっている
        → 階層構造やサーバー，中心サービスはない

P2Pネットワークの例：
- ファイル共有サービス：：Napster, BitTorrentなど

- ビットコインネットワーク
    - bitcoinのP2Pプロトコルを構成しているノードの集合である．

- 拡張ビットコインネットワーク
    - ビットコインネットワークに接続して動作しているすべてのコンポーネントを含めて「拡張ビットコインネットワーク」と呼ぶ．
        - 例えば「Stratum」というプロトコル
            - これはビットコインネットワークに接続してマイニングやモバイルウォレットを構成する別のネットワーク
            - ビットコインネットワークへGatewayの役割を持つサーバーを介して接続する
# ノード
## ノードのタイプと役割
- ビットコインのノードはflatであるが，いくつかの機能がある
- ノードの種類
1. ウォレット
2. マイニング
3. ブロックチェーンデータベース
4. ルーティング
    - 検証
    - トランザクションとブロックの伝搬
    - その他のノードの発見と接続維持

- すべてのノードはルーティング機能を備えている
    - ビットコインネットワークに参加するために必須

## ノードのタイプと役割
- フルノード
    - 最新のブロックチェーンデータを有する
    - 他のデータを参照することなくすべてのトランザクションの検証を自身で行うことができる．
-  マイニングノード
    - マイニングを行うノード
    - 新しいブロックを生成する
    - フルノードであることが多い
- SPVノード
    - ブロックチェーンデータの一部のみを持つ
    - SPV (Simplified payment verification)と呼ばれる手法で，トランザクションの検証を行う
- ウォレット
    - フルノードの一部
    - デスクトップのビットコインクライアントのようなもの
    - スマートフォンのように，リソースが限られた端末で動作するウォレットはSPVノードとなっているものが多い．

## 拡張ビットコインネットワーク
- ビットコインネットワークのノード
    - Bitcoin Core 
        - 7,000～10,000ノード
    - BitcoinJ, Libbitcoin, btcd 
        - 数百ノード
    - 独自のマイニングノード
    - 企業のノード
        - フルノードを持っている
        - 自社のサービスのエッジルーターとして使用
            - 取引所
            - ウォレット
            - ブロックエクスプローラー
            - 決済サービス
    - 周辺のシステム
        - ビットコインP2Pプロトコル以外のノード
        - 企業の自社サービスのフルノードの裏にあるものもここ
## ビットコインリレーネットワーク
#### ビットコインリレーネットワークの目的
- マイナーはPoWの解をいち早く見つけたとき、
    - 獲得したブロックをいち早くビットコインネットワーク状に伝搬させなければならない。
    - いち早く次のブロックのマイニングに着手したい

#### ビットコインリレーネットワークとは
- 2015年にMatt Coralloが開発した
- 世界中のAWS上に特殊なノードがいくつか配置され，多数のマイナーとマイニングプールを結んだ．
#### ビットコインリレーネットワークの進化
- FIBRE
    - 2016年にMatt Coralloは FIBRE (Fast Internet Bitcoin Relay Engine)でBitcoin Relay Networkをreplaceした
    - FIBREはUDBベースでのリレーネットワークで
    - コンパクトブロック最適化を実装している
    - データ転送量と遅延を削減した
- Falcon
    - Cornell大学の研究がベースになっている
    - Falconは「cut-through-routing」を「store-and-forward」の代わりに採用している
        - 完全なブロックができるまで受信するより，受信したブロックの一部でも伝搬させていくことで，遅延を少なくしている
## ネットワークの発見
- ノードを起動したとき、そのノードはどのようにしてビットコインネットワークに参加するのか？

#### ネットワークに参加するための方法
- DNSシード
    - ビットコインノードのIPアドレスリストを提供するドメイン
    - Bitcoin Coreは9つの異なるDNSシードを内部に持っている
        - https://github.com/bitcoin/bitcoin/blob/master/src/kernel/chainparams.cpp#L134
        - いくつかのIPアドレスを返す．（Aレコード）
    - 問い合わせのたびにランダムに変化する
- DNSシードを使わない場合
    - 少なくとも一つのノードのIPアドレスを与える必要がある
        - seednode オプションでノードのIPを指定
        - dnsseedオプションで0を指定するとDNSシードを使わないようにできる

- ネットワークの"発見"とは
    - 自分のIPアドレスを教えて伝搬
        - 他のノードに接続したとき，自分のIPアドレスを送信する（addrメッセージ）． そうすると，送られたノードは隣接ノードにそのIPアドレスを転送する．
    - 別のノードIPアドレス一覧を取得
        - getaddrメッセージを接続したノードに送り，その接続したノードが知っているノードのIPアドレスリストを取得する．
- Bootstrapping
    - 多様なP2P経路を保持するため，いくつかの別のノードに接続すること． 
    - コネクションは信用出来ないため，すぐに切断されることが想定され，いくつものノードに接続しておきたいためである
    - bootstrapのあとは，接続が成功したノードの情報は内部に保存しておくことで，クライアントがreboot（再起動）したあとにおいてもそれらのノードに再接続することを可能にしている

## 接続方法
- 8333ポート TCP接続
- 接続時にhandshakeをする．
    - 接続する側がversionメッセージを送信
        - nVersion
            - クライアントがしゃべるプロトコルバージョ  ン (e.g., 70002)
        - nLocalServices
            - ノードがサポートしているローカルサービスのリスト．現状 NODE_NETWORKのみ．
        - nTime
            - 現在時刻
        - addrYou
            - このノードから見えるリモートノードのIPアドレス
        - addrMe
            - このノードのIPアドレス
        - subver
            - このノードで動作しているソフトウェアの種類を表すサブバージョン(e.g., /Satoshi:0.9.2.1/)
        - bestHeight
            - このノードのブロックチェーンのブロック高

    - 接続される側がverackメッセージを返す
        - verack: 応答．特に何も情報は含まれない


